<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SAM3S Software Package: USB MSD Basic</title>
<link href="common/style.css" rel="stylesheet" type="text/css"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
    <div id="body">
        <div id="title">SAM3S Software Package 2.1</div>
        <div id="banner"></div>

<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="usb_library.html">USB Library</a>      </li>
      <li><a class="el" href="usbd_framework.html">AT91 USB device framework</a>      </li>
      <li><a class="el" href="usbd_msd_drv.html">USB Device Massstorage Driver</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>USB MSD Basic </h1>  </div>
</div>
<div class="contents">
<p>This page gives generic details on the MSD class.</p>
<h2><a class="anchor" id="Purpose"></a>
Purpose</h2>
<p>The MSD class defines how devices such as a hard disk, a USB floppy disk drive or a disk-on-key shall operate on the USB. These devices are referred to as mass storage devices, since they usually offer a high storage capacity. When plugged to a PC, a device complying to the MSD specification is accessed like any other disk on the system.</p>
<p>In practice, the specification only defines a way to wrap existing data transfer protocols, such as SCSI or the Reduced Block Commands (RBC) set. A list of the supported protocols and their uses will be given in the following section.</p>
<h2><a class="anchor" id="msc_data_tran_p"></a>
Data Transfer Protocols</h2>
<p>The <em>Mass Storagae Class Specification Overview 1.2</em> supports the following set of devices:</p>
<p>Protocols for MSD devices </p>
<table class="doxtable">
<tr>
<td><b>Subclass Code</b> </td><td><b>Command Block Spec.</b> </td><td><b>Used by</b> </td></tr>
<tr>
<td>01h </td><td>Reduced Block Commands(RBC) </td><td>Flash devices </td></tr>
<tr>
<td>02h </td><td>SFF-8020i, MMC-2 </td><td>CD &amp; DVD devices </td></tr>
<tr>
<td>03h </td><td>QIC-157 </td><td>Tape devices </td></tr>
<tr>
<td>04h </td><td>UFI </td><td>Floppy disk drives </td></tr>
<tr>
<td>05h </td><td>SFF-8070i </td><td>Floppy disk drives </td></tr>
<tr>
<td>06h </td><td>SCSI transparent command set </td><td>Any </td></tr>
</table>
<p>The SCSI transparent command set comprises all SCSI-related specifications, such as SCSI Primary Commands (SPC), SCSI Block Commands (SBC), and so on. A command will be issued by the host to determine exactly with which standard the device is compliant.</p>
<p>The protocol used by the device is specified in its Interface descriptor, in the <em>bInterfaceSubclass</em> field.</p>
<h2><a class="anchor" id="trans_pro"></a>
Transfer Protocols</h2>
<p>There are actually two different transport protocols for the MSD class:</p>
<ul>
<li>Control/Bulk/Interface (CBI) transport</li>
<li>Bulk-Only Transport (BOT)</li>
</ul>
<p>These two methods are described in two separate stand-alone documents. CBI can be considered obsolete and is being completely replaced by BOT. It was originally targeted at full-speed floppy disk drives. Therefore, the rest of this document will talk about Bulk-Only Transport exclusively.</p>
<p>Transport Protocol Codes </p>
<table class="doxtable">
<tr>
<td><b>bInterfaceProtocol</b> </td><td><b>Protocol Implementation</b> </td></tr>
<tr>
<td>00h </td><td>Control/Bulk/Interrupt protocol (with command completion interrupt) </td></tr>
<tr>
<td>01h </td><td>Control/Bulk/Interrupt protocol (without command completion interrupt) </td></tr>
<tr>
<td>50h </td><td>Bulk-only transport </td></tr>
</table>
<h2><a class="anchor" id="Architecture"></a>
Architecture</h2>
<h3><a class="anchor" id="msc_if_ep"></a>
Interfaces &amp; Endpoints</h3>
<p>An MSD device only needs one single interface. The bInterfaceClass field of the interface descriptor should be set to MSD class code (0x08), the corresponding data transfer protocol code in the <em>bInterfaceSubclass</em> field and transport protocol code in the <em>bInterfaceProtocol</em> field can be found in the tables on above.</p>
<p>Exactly three endpoints (when using the Bulk-Only Transport protocol) are necessary for MSD devices.</p>
<p>The first one is the Control endpoint 0, and is used for class-specific requests and for clearing Halt conditions on the other two endpoints. Endpoints are halted in response to errors and host bad behavior during data transfers, and the CLEAR_FEATURE request is consequently used to return them to a functional state.</p>
<p>The other two endpoints, which are of type Bulk, are used for transferring commands and data over the bus. There must be one Bulk-IN and one Bulk-OUT endpoint.</p>
<div align="center">
<img src="MSDDriverArch.png" alt="MSDDriverArch.png"/>
<p><strong>Mass Storage Device Driver Architecture</strong></p></div>
 <h3><a class="anchor" id="Class-Specific"></a>
Descriptors</h3>
<p>No class-specific descriptors for an MSD device using the Bulk-only transfport protocol.</p>
<h3><a class="anchor" id="Class-Specific"></a>
Descriptors</h3>
<p>Two class specific requests should be handled.</p>
<h4><a class="anchor" id="GetMaxLUN"></a>
GetMaxLUN</h4>
<p>A device can feature one or more Logical Unit (LU). Each of these units will be treated as a separate disk when plugged to a computer. A device can have up to 15 logical units.</p>
<p>The GET_MAX_LUN request is issued by the host to determine the maximum Logical Unit Number (LUN) supported by the device. This is not equivalent to the number of LU on the device; since units are numbered starting from 0, a device with 5 LUs should report a value of 4, which will be the index of the fifth unit.</p>
<p>Optionally, a device with only one LUN may STALL this request instead of returning a value of zero.</p>
<h4><a class="anchor" id="Bulk-Only"></a>
Mass Storage Reset</h4>
<p>This request is used to reset the state of the device and prepare it to receive commands and data. Note that the data toggle bits must not be altered by a RESET command; same for the Halt state of endpoints, i.e., halted endpoints must not be reset to a normal state.</p>
<h3><a class="anchor" id=""></a>
</h3>
<p>Each MSD transaction is divided into three steps:</p>
<ul>
<li>Command stage</li>
<li>Data stage (optional)</li>
<li>Status stage</li>
</ul>
<p>During the command stage, a Command Block Wrapper (CBW) is transmitted by the host to the device. The CBW describes several parameters of the transaction (direction, length, LUN) and carries a variable-length command block. The command block contains data in the format defined by the transfer protocol used by the device.</p>
<p>Command Block Wrapper Data Format </p>
<table class="doxtable">
<tr>
<td><b>Offset</b> </td><td><b>Field Name</b> </td><td><b>Length</b> </td><td><b>Comment</b> </td></tr>
<tr>
<td>0 </td><td>dCBWSignature </td><td>4 bytes </td><td>Signature to identify CBW, must be 43425355h </td></tr>
<tr>
<td>4 </td><td>dCBWTag </td><td>4 bytes </td><td>Tag sent by the host, echoed in the CSW </td></tr>
<tr>
<td>8 </td><td>dCBWTransferLength </td><td>4 bytes </td><td>Length of transfer during the data stage </td></tr>
<tr>
<td>12 </td><td>bmCBWFlags </td><td>1 byte </td><td>Bits 0-6: Reserved/obsolete<br/>
Bit 7: <a class="el" href="struct_transfer.html">Transfer</a> direction (0 = OUT, 1 = IN) </td></tr>
<tr>
<td>13 </td><td>bCBWLUN </td><td>1 byte </td><td>Bits 0-3: LUN to which the command is sent<br/>
Bits 4-7: Reserved </td></tr>
<tr>
<td>14 </td><td>bCBWCBLength </td><td>1 byte </td><td>Bits 0-5: Length of command block in bytes<br/>
Bits 6-7: Reserved </td></tr>
<tr>
<td>15 </td><td>CBWCB </td><td>0-16 bytes </td><td>Command block to be executed by the device </td></tr>
</table>
<p>After the device has received and interpreted the command, an optional data stage may take place if the command requires it. During this step, data is transferred either to or from the device depending on the command, in several IN/OUT transfers.</p>
<p>Once the data stage is complete, the host issues a final IN request on the Bulk-IN endpoint of the device to request the Command Status Wrapper (CSW). The CSW is used to report correct or incorrect execution of the command, as well as indicating the length of remaining data that has not been transferred.</p>
<p>Command Status Wrapper </p>
<table class="doxtable">
<tr>
<td><b>Offset</b> </td><td><b>Field Name</b> </td><td><b>Length</b> </td><td><b>Comment</b> </td></tr>
<tr>
<td>0 </td><td>dCSWSignature </td><td>4 bytes </td><td>Signature to identify CSW, must be 53425355h </td></tr>
<tr>
<td>4 </td><td>dCSWTag </td><td>4 bytes </td><td>Copy of previous CBW tag </td></tr>
<tr>
<td>8 </td><td>dCSWDataResidue </td><td>4 bytes </td><td>Difference between expected and real transfer length </td></tr>
<tr>
<td>12 </td><td>bCSWStatus </td><td>1 byte </td><td>Indicates the success or failure of the command </td></tr>
</table>
<p>These steps are all performed on the two Bulk endpoints, and do not involve Control endpoint 0 at all.</p>
<h3><a class="anchor" id="Reset"></a>
Reset</h3>
<p>When severe errors occur during command or data transfers (as defined in the <em>Mass Storage Bulk-only Transport 1.0</em> document), the device must halt both Bulk endpoints and wait for a <b>Reset Recovery</b> procedure. The Reset Recovery sequence goes as follows:</p>
<ul>
<li>The host issues a Bulk-Only Mass Storage Reset request</li>
<li>The host issues two <b>CLEAR_FEATURE</b> requests to unhalt each endpoint</li>
</ul>
<p>A device waiting for a Reset Recovery must not carry out CLEAR_FEATURE requests trying to unhalt either Bulk endpoint until after a Reset request has been received. This enables the host to distinguish between severe and minor errors.</p>
<p>The only major error defined by the Bulk-Only Transport standard is when a CBW is not valid. This means one or more of the following:</p>
<ul>
<li>The CBW is not received after a CSW has been sent or a reset.</li>
<li>The CBW is not exactly 31 bytes in length.</li>
<li>The dCBWSignature field of the CBW is not equal to 43425355h.</li>
</ul>
<h2><a class="anchor" id="host_drv"></a>
Host Drivers</h2>
<p>Almost all operating systems now provide a generic driver for the MSD class. However, the set of supported data transfer protocols may vary. For example, Microsoft Windows does not currently support the Reduced Block Command set. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>

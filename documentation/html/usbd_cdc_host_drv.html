<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SAM3S Software Package: USB CDC Serial Host Driver</title>
<link href="common/style.css" rel="stylesheet" type="text/css"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
    <div id="body">
        <div id="title">SAM3S Software Package 2.1</div>
        <div id="banner"></div>

<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="usb_library.html">USB Library</a>      </li>
      <li><a class="el" href="usbd_framework.html">AT91 USB device framework</a>      </li>
      <li><a class="el" href="usbd_cdc_serial_drv.html">USB Device CDC Serial Driver</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>USB CDC Serial Host Driver </h1>  </div>
</div>
<div class="contents">
<p>Both Microsoft Windows and Linux offer a generic driver for using a USB to serial converter device. This page details the steps required to make use of them.</p>
<h2><a class="anchor" id="Windows"></a>
Windows</h2>
<p>On Microsoft Windows, the standard USB serial driver is named usbser.sys and is part of the standard set of drivers. It has been available since Windows 98SE. However, conversely to other generic driver such as the one for Mass Storage Devices (MSD), usbser.sys is not automatically loaded when a CDC device is plugged in.</p>
<h3><a class="anchor" id="write_win_inf"></a>
Writing a Windows Driver File</h3>
<p>For Windows to recognize the device correctly, it is necessary to write a .inf file. The Windows Driver Development Kit (DDK) contains information on this topic. A basic driver, named 6119.inf in the example software provided, will now be described. The driver file is made up of several sections.</p>
<p>The first section of the .inf file must be the <b>[Version]</b> section. It contains information about the driver version, provider, release data, and so on. </p>
<div class="fragment"><pre class="fragment">[Version]
Signature=<span class="stringliteral">&quot;$Chicago$&quot;</span>
Class=Ports
ClassGuid={4D36E978-E325-11CE-BFC1-08002BE10318}
Provider=%ATMEL%
DriverVer=09/12/2006,1.1.1.1
</pre></div><p>The Signature attribute is mandatory and can be either "$Windows 95$", "$Windows NT$" or "$Chicago$", depending on which Windows version(s) the driver supports. "$Chicago$" is used to notify that every Windows version is supported. Since in this example, the USB to serial converter is a virtual COM port, the Class attribute should be equal to "Ports". The value of ClassGuid depends on which class the device uses. The Provider value indicates that the string descriptor for the driver provider will be defined further, under the tag ATMEL. Finally, the last tag show the driver version and release date. For the version number, each digit is optional (except the first one), but must not be null if present.</p>
<p>Next come two sections, <b>[SourceDisksNames]</b> and <b>[SourceDisksFiles]</b>. They are used to specify the installation disks required and the location of each needed files on these disks. But they are not implemented because the file is offered by windows or its install disk automatically. </p>
<div class="fragment"><pre class="fragment">;[SourceDisksNames]
;1=<span class="stringliteral">&quot;Windows Install CD&quot;</span>
;[SourceDisksFiles]
;usbser.sys=1
</pre></div><p>The driver file must now specify where copied files will be stored, using the <b>[DestinationDirs]</b> section. </p>
<div class="fragment"><pre class="fragment">[DestinationDirs]
DefaultDestDir=12
</pre></div><p> The target directory must be identified by its ID, which is system-defined. The ID for the drivers directory is 12.</p>
<p>The <b>[Manufacturer]</b> section lists the possible manufacturers for all devices supported by this driver. In this case, the only supported device is an ATMEL one, so this will be the only value. </p>
<div class="fragment"><pre class="fragment">[Manufacturer]
%ATMEL%=AtmelMfg
</pre></div><p>The attribute must be a string tag; its value must be the name of the Models section in which all supported devices from this manufacturer will be listed. In this case, it will be named AtmelMfg, which is the next section.</p>
<p>Each Models section must list the hardware ID of each supported device. For USB devices, the hardware ID is made up of the Vendor ID, the Product ID and (optionally) the Device Release Number. Those values are extracted from the device descriptor provided during the enumeration phase. </p>
<div class="fragment"><pre class="fragment">[AtmelMfg]
%USBtoSerialConverter%=USBtoSer.Install,USB\VID_03EB&amp;PID_6119
</pre></div><p>The attribute name is again a string tag, which will be used to describe the device. The value is comprised of both the device install section name (USBtoSer.Install) and the hardware ID. The hardware ID is the same as the one defined in "CDC Serial Device IDs".</p>
<p>Now, the .inf file must detail the install section of each device previously listed. In this example, there is only one install section, named <b>[USBtoSer.Install]</b>: </p>
<div class="fragment"><pre class="fragment">[USBtoSer.Install]
CopyFiles=USBtoSer.CopyFiles
AddReg=USBtoSer.AddReg

[USBtoSer.CopyFiles]
usbser.sys,,,0x00000002

[USBtoSer.AddReg]
HKR,,DevLoader,,*ntkern
HKR,,NTMPDriver,,usbser.sys

[USBtoSer.Install.Services]
AddService=usbser,0x00000002,USBtoSer.AddService

[USBtoSer.AddService]
DisplayName=%USBSer%
ServiceType=1r
StartType=3
ServiceBinary=%12%\usbser.sys
</pre></div><p>The install section is actually divided in five. In the first section, two other section names are specified: one for the list of files to copy, and one for the keys to add to the Windows registry. There is only one file to copy, usbser.sys; a flag (0x00000002) is used to specify that the user cannot skip copying it. The registry keys are needed to install the driver on older versions of Windows (such as Windows 98). For newer versions, the <b>[USBtoSer.Install.Services]</b> registers the needed kernel services; each service is actually listed in a section on its own.</p>
<p>Finally, the last section, [Strings], defines all the string constants used through this <a href="file:">file:</a> </p>
<div class="fragment"><pre class="fragment">[Strings]
ATMEL=<span class="stringliteral">&quot;ATMEL Corp.&quot;</span>
USBtoSerialConverter=<span class="stringliteral">&quot;AT91 USB to Serial Converter&quot;</span>
USBSer=<span class="stringliteral">&quot;USB Serial Driver&quot;</span>
</pre></div><h3><a class="anchor" id="use_win_ser_drv"></a>
Using the Driver</h3>
<p>When a new device is plugged in for the first time, Windows looks for an appropriate specific or generic driver to use it. If it does not find one, the user is asked what to do.</p>
<p>This is the case with the USB to serial converter, since there is no generic driver for it. To install the custom driver given in the previous section, Windows must be told where to look for it. This can be done by selecting the second option, "Install from a list or specific location", when the driver installation wizards pops up. It will then ask for the directory where the driver is located. After that, it should recognize the "AT91 USB to Serial
 Converter" driver as an appropriate one and display it in the list.</p>
<p>During the installation, the wizard asks for the location of the usbser.sys file. If it is already installed on the system, it can be found in "C:\Windows\System32\Drivers\". Otherwise, it is present on the Windows installation CD.</p>
<p>Once the driver is installed properly, a new COM port is added to the system and can be used with HyperTerminal, for example.</p>
<h2><a class="anchor" id="Linux"></a>
Linux</h2>
<p>Linux has two different generic drivers which are appropriate for a USB to serial converter. The first one is an Abstract Control Model driver designed for modem devices, and is simply named <b>acm</b>. The other one is a generic USB to serial driver named <b>usbserial</b>.</p>
<p>If the support for the <b>acm</b> driver has been compiled in the kernel, Linux will automatically load it. A new terminal device will be created under /dev/ttyACMx.</p>
<p>The usbserial driver must be loaded manually by using the modprobe command with the vendor ID and product ID values used by the device: </p>
<div class="fragment"><pre class="fragment"> modprobe usbserial vendor=0x03EB product=0x6119
</pre></div><p>Once the driver is loaded, a new terminal entry appears and should be named /dev/ttyUSBx. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>

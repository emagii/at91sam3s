<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SAM3S Software Package: USB Composite Devices Drivers</title>
<link href="common/style.css" rel="stylesheet" type="text/css"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
    <div id="body">
        <div id="title">SAM3S Software Package 2.1</div>
        <div id="banner"></div>

<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="usb_library.html">USB Library</a>      </li>
      <li><a class="el" href="usbd_framework.html">AT91 USB device framework</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>USB Composite Devices Drivers </h1>  </div>
</div>
<div class="contents">
<p>This page describes how to use the <a class="el" href="usbd_framework.html">AT91 USB device framework</a> to produce a USB Composite Device Driver, which appears as two USB Functions on host.</p>
<p>Details about the USB can be found in the <em>USB specification 2.0</em>, respectively.</p>
<h2><a class="anchor" id="References"></a>
References</h2>
<ul>
<li><a href="http://www.usb.org/developers/docs/usb_20_122909-2.zip">Universal Serial Bus Revision 2.0 specification </a> (.zip file format, size 10.9 MB)</li>
<li><a href="http://www.usb.org/developers/docs/InterfaceAssociationDescriptor_ecn.pdf">Interface Association Descriptor </a></li>
<li><a class="el" href="usbd_framework.html">AT91 USB device framework</a></li>
<li><a class="el" href="usbd_enum.html">USB Device Enumeration</a></li>
<li><a class="el" href="usbd_cdc_serial_drv.html">USB CDC(Serial) Device Driver</a></li>
<li><a class="el" href="usbd_msd_drv.html">USB MSD Device Driver</a></li>
<li><a class="el" href="usbd_hid_kbd_drv.html">USB HID(Keyboard) Device Driver</a></li>
<li><a class="el" href="usbd_audio_speaker_drv.html">USB Audio(Speaker) Device Driver</a></li>
</ul>
<h2><a class="anchor" id="composite_basic"></a>
Composite Basics</h2>
<p>See <a class="el" href="usb_composite_basic.html">USB Composite Basics</a></p>
<h2><a class="anchor" id="Architecture"></a>
Architecture</h2>
<p>The Composite driver is based on <a class="el" href="usbd_framework_arch.html">USB Device Framework Architecture</a>.</p>
<div align="center">
<img src="UsbCompositeSWArch.png" alt="UsbCompositeSWArch.png"/>
<p><strong>Software Architecture Using the AT91 USB Framework</strong></p></div>
 <h2><a class="anchor" id="Descriptors"></a>
Descriptors</h2>
<h3><a class="anchor" id="usb_composite_devdesc"></a>
Device Descriptor</h3>
<p>The Device descriptor of a composite device is very basic according to the definition in section 9.6.1, <em>Universal Serial Bus Specification, Revision 2.0</em>, but some of the fields may have different values based on if there is multi-interface function in the device: <em>bDeviceClass</em>, <em>bDeviceSubClass</em>, <em>bDeviceProtocol</em> set to zero for a device without multi-interface function inside; <em>bDeviceClass</em>, <em>bDeviceSubClass</em>, <em>bDeviceProtocol</em> set to EFH, 02H, 01H for a device with multi-interface function inside, such as CDC or Audio class function, as shown below:</p>
<div class="fragment"><pre class="fragment">        <span class="comment">// Composite Device Descriptor</span>
        <span class="keyword">const</span> USBDeviceDescriptor deviceDescriptor = {
                <span class="keyword">sizeof</span>(USBDeviceDescriptor),
                <a class="code" href="group__usb__desc__type.html#ga6363c61655b33b6312f0de0f317528e3">USBGenericDescriptor_DEVICE</a>,
                <a class="code" href="group__usb__release__number.html#ga69167f83b560d92391cf222d9d3690de">USBDeviceDescriptor_USB2_00</a>,
              #<span class="keywordflow">if</span> defined(usb_HIDMSD)
                0x00,
                0x00,
                0x00,
<span class="preprocessor">              #else</span>
<span class="preprocessor"></span>                0xEF,<span class="comment">// MI</span>
                0x02,<span class="comment">//</span>
                0x01,<span class="comment">//</span>
<span class="preprocessor">              #endif</span>
<span class="preprocessor"></span>                BOARD_USB_ENDPOINTS_MAXPACKETSIZE(0),
                COMPOSITEDDriverDescriptors_VENDORID,
                COMPOSITEDDriverDescriptors_PRODUCTID,
                COMPOSITEDDriverDescriptors_RELEASE,
                0, <span class="comment">// No string descriptor for manufacturer</span>
                1, <span class="comment">// Index of product string descriptor is #1</span>
                0, <span class="comment">// No string descriptor for serial number</span>
                1 <span class="comment">// Device has 1 possible configuration</span>
        };
</pre></div><p>Note that the Vendor ID is a special value attributed by the USB-IF organization. The product ID can be chosen freely by the vendor. The HID and MSD class functions are all single-interface functions, so the corresponding fields are set to zeros.</p>
<h3><a class="anchor" id="usb_composite_cfgdesc"></a>
Configuration Descriptor</h3>
<p>It's just standard one as defined in section 9.6.3, <em>Universal Serial Bus Specification, Revision 2.0</em>, with <em>wTotalLength</em> set to the total length of all standard and function specific descriptors followed, <em>bNumInterface</em> set to the summary number of interfaces of all functions used.</p>
<div class="fragment"><pre class="fragment">        <span class="comment">// Composite Configuration Descriptor</span>
        {
                <span class="keyword">sizeof</span>(USBConfigurationDescriptor),
                <a class="code" href="group__usb__desc__type.html#ga3a0e7ca09c79c9b17866b19770d7dfe7">USBGenericDescriptor_CONFIGURATION</a>,
                <span class="keyword">sizeof</span>(CompositeDriverConfigurationDescriptors),
                COMPOSITEDDriverDescriptors_NUMINTERFACE,
                1, <span class="comment">// This is configuration #1</span>
                0, <span class="comment">// No string descriptor for this configuration</span>
                BOARD_USB_BMATTRIBUTES,
                <a class="code" href="group__usb__attributes.html#gab63528cba8ea4c8178d79393caa5d5f1">USBConfigurationDescriptor_POWER</a>(100)
        },
</pre></div><p>When the Configuration descriptor is requested by the host (by using the GET_DESCRIPTOR command), the device must also send all the related descriptors, i.e. IAD, Interface, <a class="el" href="struct_endpoint.html">Endpoint</a> and Class-specific descriptors. It is convenient to create a single structure to hold all this data, for sending everything in one trunk.</p>
<h3><a class="anchor" id="IAD"></a>
IAD</h3>
<p>See <a class="el" href="usb_composite_basic.html#usb_composite_iad">Interface Association Descriptor</a>.</p>
<h3><a class="anchor" id="usb_composite_ifepdesc"></a>
Interface, Class-Specific &amp; Endpoint Descriptors</h3>
<p>All these descriptors are almost the same as their definitions in a single USB device, except the interface index related or endpoint addresses related settings. Please refer to the following projects:</p>
<ul>
<li>MSD: <a class="el" href="usbd_msd_drv.html">USB Device Massstorage Driver</a>, <a class="el" href="usb_massstorage.html">USB Device Mass Storage Example</a></li>
<li>CDC: <a class="el" href="usbd_cdc_serial_drv.html">USB Device CDC Serial Driver</a>, <a class="el" href="usb_cdc_serial.html">USB CDC Serial Converter Example</a></li>
<li>HID: <a class="el" href="usbd_hid_kbd_drv.html">USB Device HID Keyboard Driver</a>, <a class="el" href="usb_hid_keyboard.html">USB HID Keyboard Example</a></li>
<li>Audio: <a class="el" href="usbd_audio_speaker_drv.html">USB Device Audio Speaker Driver</a>, <a class="el" href="usb_audio_speaker.html">USB Audio Speaker Example</a></li>
</ul>
<h3><a class="anchor" id="usb_composite_strdesc"></a>
String Descriptors</h3>
<p>Several descriptors can be commented with a String Descriptor. The latter is completely optional and does not have any effect on the detection of the device by the operating system. Whether or not to include them is entirely up to the programmer.</p>
<p>There is one exception to this rule when using the MSD class. According to the specification, there must be a <b>Serial Number</b> string. It must contains at least 12 characters, and these character must only be either letters (a-z, A-Z) or numbers (0-9). This cause no problem for the driver in practice, but this is a strict requirement for certification. Also please remember that string descriptors use the <b>Unicode</b> format.</p>
<h2><a class="anchor" id="Requests"></a>
Requests</h2>
<p>The composite itself does not define any special requests, but the device functions do.</p>
<p>Each function in the device has its own requests handler. The device invokes one of the function requests handler first, when the return value of the handler indicates the request is handled by the device function, then the device request handler return directly, but if it is not handled, the device request handler calls next function request handler to check it. It will be forwarded to the standard request handler if there is no valid handler for this request.</p>
<p>In the device function request handlers, <em>wIndex</em> of the request is checked first to confirm that the request is accepted by the function (interface). Then check if it is a standard request and handle it in two different way.</p>
<div align="center">
<img src="UsbCompositeRequestHandler.png" alt="UsbCompositeRequestHandler.png"/>
<p><strong>General Request Handler for Composite Device</strong></p></div>
<p> For class-specific request, refer to their related documents:</p>
<ul>
<li>MSD: <a class="el" href="usbd_msd_drv.html">USB Device Massstorage Driver</a>, <a class="el" href="usb_massstorage.html">USB Device Mass Storage Example</a></li>
<li>CDC: <a class="el" href="usbd_cdc_serial_drv.html">USB Device CDC Serial Driver</a>, <a class="el" href="usb_cdc_serial.html">USB CDC Serial Converter Example</a></li>
<li>HID: <a class="el" href="usbd_hid_kbd_drv.html">USB Device HID Keyboard Driver</a>, <a class="el" href="usb_hid_keyboard.html">USB HID Keyboard Example</a></li>
<li>Audio: <a class="el" href="usbd_audio_speaker_drv.html">USB Device Audio Speaker Driver</a>, <a class="el" href="usb_audio_speaker.html">USB Audio Speaker Example</a></li>
</ul>
<h2><a class="anchor" id="Notifications"></a>
Notifications</h2>
<p>Notifications are supported only if CDC serial port device function is included, please refer to <a class="el" href="usbd_cdc_serial_drv.html">USB Device CDC Serial Driver</a>.</p>
<h2><a class="anchor" id="Callbacks"></a>
Callbacks</h2>
<p>The function in the device may need some callbacks to handle the USB events, such as configured or changed interface.</p>
<h3><a class="anchor" id="composite_hid_kbd_cb"></a>
HID Keybard Function Callbacks</h3>
<p>For a HID Keyboard, the device function should start reporting to host through interrupt endpoint as soon as the device is configured, so <a class="el" href="usb_2usb__audio__headphone_2main_8c.html#ga060334ef6d83b4d98ea8bf3720c018a6">USBDDriverCallbacks_ConfigurationChanged()</a> should be re-implement to monitor the configured status of the device, and then forward the event to the device function to handle it. For more details, see <a class="el" href="usbd_hid_kbd_drv.html">USB Device HID Keyboard Driver</a>.</p>
<h3><a class="anchor" id="composite_aud_cb"></a>
Audio Speaker Function Callbacks</h3>
<p>The USB Audio Speaker defines alternative interfaces to control the USB bandwidth, so there is a callback defined to handle the event of AT91 USB Device Framework. The function is <a class="el" href="usb_2usb__audio__headphone_2main_8c.html#ga0aac37940a604b58ead5414a07cb3770">USBDDriverCallbacks_InterfaceSettingChanged()</a>, which should be re-implemented to replace the original one. AUDDFunctionCallbacks_InterfaceSettingChanged() is invoked and then let the Audio Device Function to handle the event. For more details, see <a class="el" href="usbd_audio_speaker_drv.html">USB Device Audio Speaker Driver</a>.</p>
<h2><a class="anchor" id="composite_driver_demo"></a>
Composite Device Examples</h2>
<h3><a class="anchor" id=""></a>
</h3>
<div align="center">
<img src="UsbCompositeHidMsdArch.png" alt="UsbCompositeHidMsdArch.png"/>
<p><strong>HID MSD Composite Driver Architecture</strong></p></div>
<p> Device descriptors: </p>
<div class="fragment"><pre class="fragment">        <span class="keyword">typedef</span> <span class="keyword">struct </span>{
                <span class="comment">// Standard configuration descriptor.</span>
                USBConfigurationDescriptor <a class="code" href="cciddriver_8c.html#a7634569d696db5c0fd83c1f138267913">configuration</a>;
                <span class="comment">// --- HID</span>
                USBInterfaceDescriptor <a class="code" href="_h_i_d_a_u_d_d_driver_8h.html#adf545d62366051a658986acf15dfd67c">hidInterface</a>;
                HIDDescriptor hid;
                USBEndpointDescriptor <a class="code" href="_h_i_d_a_u_d_d_driver_8h.html#ad8a2af8ae118ce105e4cb713fcf2cbe8">hidInterruptIn</a>;
                USBEndpointDescriptor <a class="code" href="_h_i_d_a_u_d_d_driver_8h.html#a5751b395563535f996732104548a1646">hidInterruptOut</a>;
                <span class="comment">// --- MSD</span>
                <span class="comment">// Mass storage interface descriptor.</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_m_s_d_driver_8h.html#a6942c17ffd6ff3bf3bdcd1268ab7348a">msdInterface</a>;
                <span class="comment">// Bulk-out endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_m_s_d_driver_8h.html#acaaebf4e0a7d7b68cb5553945e0934d3">msdBulkOut</a>;
                <span class="comment">// Bulk-in endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_m_s_d_driver_8h.html#ad151d053f8c303d8f7d19de040abfc24">msdBulkIn</a>;
        } <a class="code" href="crccu_2main_8c.html#a9f6ee749d278fbad2139258ca8a115dc">__attribute__</a> ((packed)) CompositeDriverConfigurationDescriptors;
</pre></div><h3><a class="anchor" id=""></a>
</h3>
<div align="center">
<img src="UsbCompositeHidAudioArch.png" alt="UsbCompositeHidAudioArch.png"/>
<p><strong>HID Audio Composite Device Architecture</strong></p></div>
<p> Device descriptors: </p>
<div class="fragment"><pre class="fragment">        <span class="keyword">typedef</span> <span class="keyword">struct </span>{
                <span class="comment">// Standard configuration descriptor.</span>
                USBConfigurationDescriptor <a class="code" href="cciddriver_8c.html#a7634569d696db5c0fd83c1f138267913">configuration</a>;
                <span class="comment">// --- HID</span>
                USBInterfaceDescriptor <a class="code" href="_h_i_d_a_u_d_d_driver_8h.html#adf545d62366051a658986acf15dfd67c">hidInterface</a>;
                HIDDescriptor hid;
                USBEndpointDescriptor <a class="code" href="_h_i_d_a_u_d_d_driver_8h.html#ad8a2af8ae118ce105e4cb713fcf2cbe8">hidInterruptIn</a>;
                USBEndpointDescriptor <a class="code" href="_h_i_d_a_u_d_d_driver_8h.html#a5751b395563535f996732104548a1646">hidInterruptOut</a>;
                <span class="comment">// --- AUDIO</span>
                <span class="comment">// IAD 1</span>
                USBInterfaceAssociationDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a0a519ce1f853fe23c0b6b687cff55b97">audIAD</a>;
                <span class="comment">// Audio control interface.</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a4608fb4209f8be190460dd615ca4cf1a">audInterface</a>;
                <span class="comment">// Descriptors for the audio control interface.</span>
                AUDDSpeakerDriverAudioControlDescriptors <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa4a4953434cd7bcb34647112ebcf07d8">audControl</a>;
                <span class="comment">// -- AUDIO out</span>
                <span class="comment">// Streaming out interface descriptor (with no endpoint, required).</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a17434929efa6c9373652f28cb103f7b7">audStreamingOutNoIsochronous</a>;
                <span class="comment">// Streaming out interface descriptor.</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a4854c5bc385d8483a34dedee6f52b950">audStreamingOut</a>;
                <span class="comment">// Audio class descriptor for the streaming out interface.</span>
                AUDStreamingInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a9a9100f2f233c27c56a24143f02f6ec3">audStreamingOutClass</a>;
                <span class="comment">// Stream format descriptor.</span>
                AUDFormatTypeOneDescriptor1 <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#af406cc3254606674b0089c46c5deb291">audStreamingOutFormatType</a>;
                <span class="comment">// Streaming out endpoint descriptor.</span>
                AUDEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a84580ef7e37e69f70a39dbdcd5f9ce34">audStreamingOutEndpoint</a>;
                <span class="comment">// Audio class descriptor for the streaming out endpoint.</span>
                AUDDataEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a505f727a9873ccd2d57a0e2f1795eb3b">audStreamingOutDataEndpoint</a>;
        } <a class="code" href="crccu_2main_8c.html#a9f6ee749d278fbad2139258ca8a115dc">__attribute__</a> ((packed)) CompositeDriverConfigurationDescriptors;
</pre></div><h3><a class="anchor" id=""></a>
</h3>
<div align="center">
<img src="UsbCompositeCdcHidArch.png" alt="UsbCompositeCdcHidArch.png"/>
<p><strong>CDC HID Composite Device Architecture</strong></p></div>
<p> Device descriptors: </p>
<div class="fragment"><pre class="fragment">        <span class="keyword">typedef</span> <span class="keyword">struct </span>{
                <span class="comment">// Standard configuration descriptor.</span>
                USBConfigurationDescriptor <a class="code" href="cciddriver_8c.html#a7634569d696db5c0fd83c1f138267913">configuration</a>;
                <span class="comment">// --- CDC 0</span>
                <span class="comment">// IAD 0</span>
                USBInterfaceAssociationDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a10e9712133dce252b4f935d8bdc29c21">cdcIAD0</a>;
                <span class="comment">// Communication interface descriptor</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa9be227f0fdb16bbc76d3c88ad08af1d">cdcCommunication0</a>;
                <span class="comment">// CDC header functional descriptor.</span>
                CDCHeaderDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa34f7deba5b9aabde1e151d0736f2cc6">cdcHeader0</a>;
                <span class="comment">// CDC call management functional descriptor.</span>
                CDCCallManagementDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aec59139b3cec83ae3da86d2cc87f8a85">cdcCallManagement0</a>;
                <span class="comment">// CDC abstract control management functional descriptor.</span>
                CDCAbstractControlManagementDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a1ec286fa10991a943613adaa21258b2c">cdcAbstractControlManagement0</a>;
                <span class="comment">// CDC union functional descriptor (with one slave interface).</span>
                CDCUnionDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a8476c8e7002f57248281bf1fe334cf04">cdcUnion0</a>;
                <span class="comment">// Notification endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa35f0c3a7e80667b49fa9852a730db2e">cdcNotification0</a>;
                <span class="comment">// Data interface descriptor.</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#af4203e891eb0d63bdbc3608d3547c641">cdcData0</a>;
                <span class="comment">// Data OUT endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a008218f7a92c6c6903400443f1bf6cf5">cdcDataOut0</a>;
                <span class="comment">// Data IN endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#acd026c03018ac9b12c5f6bc5d82fe1ef">cdcDataIn0</a>;
                <span class="comment">// --- HID</span>
                USBInterfaceDescriptor <a class="code" href="_h_i_d_a_u_d_d_driver_8h.html#adf545d62366051a658986acf15dfd67c">hidInterface</a>;
                HIDDescriptor hid;
                USBEndpointDescriptor <a class="code" href="_h_i_d_a_u_d_d_driver_8h.html#ad8a2af8ae118ce105e4cb713fcf2cbe8">hidInterruptIn</a>;
                USBEndpointDescriptor <a class="code" href="_h_i_d_a_u_d_d_driver_8h.html#a5751b395563535f996732104548a1646">hidInterruptOut</a>;
        } <a class="code" href="crccu_2main_8c.html#a9f6ee749d278fbad2139258ca8a115dc">__attribute__</a> ((packed)) CompositeDriverConfigurationDescriptors;
</pre></div><h3><a class="anchor" id=""></a>
</h3>
<div align="center">
<img src="UsbCompositeCdcMsdArch.png" alt="UsbCompositeCdcMsdArch.png"/>
<p><strong>CDC MSD Composite Device Architecture</strong></p></div>
<p> Device descriptors: </p>
<div class="fragment"><pre class="fragment">        <span class="keyword">typedef</span> <span class="keyword">struct </span>{
                <span class="comment">// Standard configuration descriptor.</span>
                USBConfigurationDescriptor <a class="code" href="cciddriver_8c.html#a7634569d696db5c0fd83c1f138267913">configuration</a>;
                <span class="comment">// --- CDC 0</span>
                <span class="comment">// IAD 0</span>
                USBInterfaceAssociationDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a10e9712133dce252b4f935d8bdc29c21">cdcIAD0</a>;
                <span class="comment">// Communication interface descriptor</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa9be227f0fdb16bbc76d3c88ad08af1d">cdcCommunication0</a>;
                <span class="comment">// CDC header functional descriptor.</span>
                CDCHeaderDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa34f7deba5b9aabde1e151d0736f2cc6">cdcHeader0</a>;
                <span class="comment">// CDC call management functional descriptor.</span>
                CDCCallManagementDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aec59139b3cec83ae3da86d2cc87f8a85">cdcCallManagement0</a>;
                <span class="comment">// CDC abstract control management functional descriptor.</span>
                CDCAbstractControlManagementDescriptor cdcAbstractControlManag
                <span class="comment">// CDC union functional descriptor (with one slave interface).</span>
                CDCUnionDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a8476c8e7002f57248281bf1fe334cf04">cdcUnion0</a>;
                <span class="comment">// Notification endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa35f0c3a7e80667b49fa9852a730db2e">cdcNotification0</a>;
                <span class="comment">// Data interface descriptor.</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#af4203e891eb0d63bdbc3608d3547c641">cdcData0</a>;
                <span class="comment">// Data OUT endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a008218f7a92c6c6903400443f1bf6cf5">cdcDataOut0</a>;
                <span class="comment">// Data IN endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#acd026c03018ac9b12c5f6bc5d82fe1ef">cdcDataIn0</a>;
                <span class="comment">// --- MSD</span>
                <span class="comment">// Mass storage interface descriptor.</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_m_s_d_driver_8h.html#a6942c17ffd6ff3bf3bdcd1268ab7348a">msdInterface</a>;
                <span class="comment">// Bulk-out endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_m_s_d_driver_8h.html#acaaebf4e0a7d7b68cb5553945e0934d3">msdBulkOut</a>;
                <span class="comment">// Bulk-in endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_m_s_d_driver_8h.html#ad151d053f8c303d8f7d19de040abfc24">msdBulkIn</a>;
        } <a class="code" href="crccu_2main_8c.html#a9f6ee749d278fbad2139258ca8a115dc">__attribute__</a> ((packed)) CompositeDriverConfigurationDescriptors;
</pre></div><h3><a class="anchor" id=""></a>
</h3>
<div align="center">
<img src="UsbCompositeCdcAudioArch.png" alt="UsbCompositeCdcAudioArch.png"/>
<p><strong>CDC Audio Composite Device Architecture</strong></p></div>
<p> Device descriptors: </p>
<div class="fragment"><pre class="fragment">        <span class="keyword">typedef</span> <span class="keyword">struct </span>{
                <span class="comment">// Standard configuration descriptor.</span>
                USBConfigurationDescriptor <a class="code" href="cciddriver_8c.html#a7634569d696db5c0fd83c1f138267913">configuration</a>;
                <span class="comment">// --- CDC 0</span>
                <span class="comment">// IAD 0</span>
                USBInterfaceAssociationDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a10e9712133dce252b4f935d8bdc29c21">cdcIAD0</a>;
                <span class="comment">// Communication interface descriptor</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa9be227f0fdb16bbc76d3c88ad08af1d">cdcCommunication0</a>;
                <span class="comment">// CDC header functional descriptor.</span>
                CDCHeaderDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa34f7deba5b9aabde1e151d0736f2cc6">cdcHeader0</a>;
                <span class="comment">// CDC call management functional descriptor.</span>
                CDCCallManagementDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aec59139b3cec83ae3da86d2cc87f8a85">cdcCallManagement0</a>;
                <span class="comment">// CDC abstract control management functional descriptor.</span>
                CDCAbstractControlManagementDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a1ec286fa10991a943613adaa21258b2c">cdcAbstractControlManagement0</a>;
                <span class="comment">// CDC union functional descriptor (with one slave interface).</span>
                CDCUnionDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a8476c8e7002f57248281bf1fe334cf04">cdcUnion0</a>;
                <span class="comment">// Notification endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa35f0c3a7e80667b49fa9852a730db2e">cdcNotification0</a>;
                <span class="comment">// Data interface descriptor.</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#af4203e891eb0d63bdbc3608d3547c641">cdcData0</a>;
                <span class="comment">// Data OUT endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a008218f7a92c6c6903400443f1bf6cf5">cdcDataOut0</a>;
                <span class="comment">// Data IN endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#acd026c03018ac9b12c5f6bc5d82fe1ef">cdcDataIn0</a>;
                <span class="comment">// --- AUDIO</span>
                <span class="comment">// IAD 1</span>
                USBInterfaceAssociationDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a0a519ce1f853fe23c0b6b687cff55b97">audIAD</a>;
                <span class="comment">// Audio control interface.</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a4608fb4209f8be190460dd615ca4cf1a">audInterface</a>;
                <span class="comment">// Descriptors for the audio control interface.</span>
                AUDDSpeakerDriverAudioControlDescriptors <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa4a4953434cd7bcb34647112ebcf07d8">audControl</a>;
                <span class="comment">// -- AUDIO out</span>
                <span class="comment">// Streaming out interface descriptor (with no endpoint, required).</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a17434929efa6c9373652f28cb103f7b7">audStreamingOutNoIsochronous</a>;
                <span class="comment">// Streaming out interface descriptor.</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a4854c5bc385d8483a34dedee6f52b950">audStreamingOut</a>;
                <span class="comment">// Audio class descriptor for the streaming out interface.</span>
                AUDStreamingInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a9a9100f2f233c27c56a24143f02f6ec3">audStreamingOutClass</a>;
                <span class="comment">// Stream format descriptor.</span>
                AUDFormatTypeOneDescriptor1 <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#af406cc3254606674b0089c46c5deb291">audStreamingOutFormatType</a>;
                <span class="comment">// Streaming out endpoint descriptor.</span>
                AUDEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a84580ef7e37e69f70a39dbdcd5f9ce34">audStreamingOutEndpoint</a>;
                <span class="comment">// Audio class descriptor for the streaming out endpoint.</span>
                AUDDataEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a505f727a9873ccd2d57a0e2f1795eb3b">audStreamingOutDataEndpoint</a>;
        } <a class="code" href="crccu_2main_8c.html#a9f6ee749d278fbad2139258ca8a115dc">__attribute__</a> ((packed)) CompositeDriverConfigurationDescriptors;
</pre></div><h3><a class="anchor" id=""></a>
</h3>
<div align="center">
<img src="UsbCompositeCdcCdcArch.png" alt="UsbCompositeCdcCdcArch.png"/>
<p><strong>Dual CDC Composite Device Architecture</strong></p></div>
<p> Device descriptors: </p>
<div class="fragment"><pre class="fragment">        <span class="keyword">typedef</span> <span class="keyword">struct </span>{
                <span class="comment">// Standard configuration descriptor.</span>
                USBConfigurationDescriptor <a class="code" href="cciddriver_8c.html#a7634569d696db5c0fd83c1f138267913">configuration</a>;
                <span class="comment">// --- CDC 0</span>
                <span class="comment">// IAD 0</span>
                USBInterfaceAssociationDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a10e9712133dce252b4f935d8bdc29c21">cdcIAD0</a>;
                <span class="comment">// Communication interface descriptor</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa9be227f0fdb16bbc76d3c88ad08af1d">cdcCommunication0</a>;
                <span class="comment">// CDC header functional descriptor.</span>
                CDCHeaderDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa34f7deba5b9aabde1e151d0736f2cc6">cdcHeader0</a>;
                <span class="comment">// CDC call management functional descriptor.</span>
                CDCCallManagementDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aec59139b3cec83ae3da86d2cc87f8a85">cdcCallManagement0</a>;
                <span class="comment">// CDC abstract control management functional descriptor.</span>
                CDCAbstractControlManagementDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a1ec286fa10991a943613adaa21258b2c">cdcAbstractControlManagement0</a>;
                <span class="comment">// CDC union functional descriptor (with one slave interface).</span>
                CDCUnionDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a8476c8e7002f57248281bf1fe334cf04">cdcUnion0</a>;
                <span class="comment">// Notification endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#aa35f0c3a7e80667b49fa9852a730db2e">cdcNotification0</a>;
                <span class="comment">// Data interface descriptor.</span>
                USBInterfaceDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#af4203e891eb0d63bdbc3608d3547c641">cdcData0</a>;
                <span class="comment">// Data OUT endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#a008218f7a92c6c6903400443f1bf6cf5">cdcDataOut0</a>;
                <span class="comment">// Data IN endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_c_d_c_a_u_d_d_driver_8h.html#acd026c03018ac9b12c5f6bc5d82fe1ef">cdcDataIn0</a>;
                <span class="comment">// --- CDC 1</span>
                <span class="comment">// IAD 1</span>
                USBInterfaceAssociationDescriptor <a class="code" href="_d_u_a_l_c_d_c_d_driver_8h.html#aa2597a0078039f80fdd4e7b9772cb8b2">cdcIAD1</a>;
                <span class="comment">// Communication interface descriptor</span>
                USBInterfaceDescriptor <a class="code" href="_d_u_a_l_c_d_c_d_driver_8h.html#a4dc5735f54fce57d5269b53e27e5348d">cdcCommunication1</a>;
                <span class="comment">// CDC header functional descriptor.</span>
                CDCHeaderDescriptor <a class="code" href="_d_u_a_l_c_d_c_d_driver_8h.html#a12820389f40db71fc505d59ef538d2f5">cdcHeader1</a>;
                <span class="comment">// CDC call management functional descriptor.</span>
                CDCCallManagementDescriptor <a class="code" href="_d_u_a_l_c_d_c_d_driver_8h.html#af7f3d45b5d0b228e9f7148e072f9be5c">cdcCallManagement1</a>;
                <span class="comment">// CDC abstract control management functional descriptor.</span>
                CDCAbstractControlManagementDescriptor <a class="code" href="_d_u_a_l_c_d_c_d_driver_8h.html#a398768002d0c102630c3661ec0148309">cdcAbstractControlManagement1</a>;
                <span class="comment">// CDC union functional descriptor (with one slave interface).</span>
                CDCUnionDescriptor <a class="code" href="_d_u_a_l_c_d_c_d_driver_8h.html#a1d9b3cfbc8afa5edf499bb1aa38ba54f">cdcUnion1</a>;
                <span class="comment">// Notification endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_d_u_a_l_c_d_c_d_driver_8h.html#af49fd1d4008cbf4e50bb718b54c6206f">cdcNotification1</a>;
                <span class="comment">// Data interface descriptor.</span>
                USBInterfaceDescriptor <a class="code" href="_d_u_a_l_c_d_c_d_driver_8h.html#a7b04a06315cb0da056699c5c1458c3a2">cdcData1</a>;
                <span class="comment">// Data OUT endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_d_u_a_l_c_d_c_d_driver_8h.html#a3c90ff524b3ab55308d224a4f4641008">cdcDataOut1</a>;
                <span class="comment">// Data IN endpoint descriptor.</span>
                USBEndpointDescriptor <a class="code" href="_d_u_a_l_c_d_c_d_driver_8h.html#af545ad2ad651c1503450fa28aebc85a9">cdcDataIn1</a>;
        } <a class="code" href="crccu_2main_8c.html#a9f6ee749d278fbad2139258ca8a115dc">__attribute__</a> ((packed)) CompositeDriverConfigurationDescriptors;
</pre></div><h2><a class="anchor" id="composite_main"></a>
Main Application</h2>
<p>Normally the main application code can be divided into four parts:</p>
<ul>
<li>initialization</li>
<li>interrupt handlers</li>
<li>callback handlers</li>
<li>main loop See the source code and the device related application notes for more details.</li>
</ul>
<h3><a class="anchor" id="Initialization"></a>
Initialization</h3>
<p>This part initializes all peripherals and drivers, depending on the functions which are included. Normally there are following general initializations:</p>
<ul>
<li>debug initialization</li>
<li>USB Vbus detect (PIO) initialization</li>
<li>composite device driver initialization</li>
<li>initializations are based on the working functions:<ul>
<li>clock PIO and clock settings for USB Audio device</li>
<li>HID keyboard PIO initialization</li>
<li>AC97 or SPI &amp; SSC or DAC for Audio playback initialization</li>
<li>MSD Media and LUN initialization</li>
<li>extra initializations may be needed for timers.</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="usb_composite_irq_handler"></a>
Interrupt Handlers</h3>
<p>This part includes the necessary handler for Vbus detect, the media handler for MSD device function, USART handler for CDC serial port, and the SSC handler for Audio device function if needed. One extra handler may be needed for the timer or PIT or SYSTICK.</p>
<h3><a class="anchor" id="Callbacks"></a>
Callbacks</h3>
<p>Some of the device function requires callback handler to execute the request from host, such as the mute state changed by the host, or data received or sent, so that another transfer can be started.</p>
<h3><a class="anchor" id="usb_composite_main_loop"></a>
Main Loop</h3>
<p>All driver function is non-blocked function, and many of them is called in the main loop, to receive data from the host, to scan the input keys and send report to host (for HID), to run the state machine (for MSD).</p>
<h2><a class="anchor" id="composite_host_driver"></a>
Using a Generic Host Driver</h2>
<p>The device functions are generally supported by Microsoft Windows, but for composite device, some patches are needed. All the composite devices above are tested under windows XP (SP3) and works fine. For CDC serial port, additional windows driver file (.inf) is required.</p>
<h3><a class="anchor" id="usb_composite_win_patch"></a>
Windows Patches</h3>
<p>See <a class="el" href="usb_composite_win_driver_up.html">Windows Driver Update For Composite</a>.</p>
<h3><a class="anchor" id="usb_composite_win_cdc_inf"></a>
Windows Driver Files for CDC Serial Function</h3>
<p>In order to make windows recognize the CDC serial device correctly, it is necessary to write a .inf file. Please refer to <a class="el" href="usbd_cdc_serial_drv.html">USB Device CDC Serial Driver</a> for detailed information. Only one thing should be modified to match the composite device function installation.</p>
<p>For composite devices, the hardware ID is made up of the Vender ID, the Product ID and (optionally) the Device Release Number and the start interface number of the function. Those values are extracted from the device descriptors provided during the enumeration phase, the following is the example of the modification for the dual-port CDC serial:</p>
<div class="fragment"><pre class="fragment">[AtmelMfg]
%USBtoSerialConverter%=USBtoSer.Install,USB\VID_03EB&amp;PID_6119&amp;MI_00 ; 1st 
COM device
%USBtoSerialConverter%=USBtoSer.Install,USB\VID_03EB&amp;PID_6119&amp;MI_02 ; 2nd COM device 
</pre></div><p>When a new device is plugged in for the first time, Windows looks for an appropriate specific or generic driver to use it. The composite device will be recognized as ¡°USB Composite Device¡±. Then Windows search the driver for the functions inside the composite device.</p>
<p>Please refer to the driver function related application notes for more details. The final installation file is as following:</p>
<div class="fragment"><pre class="fragment">[Version]
Signature=<span class="stringliteral">&quot;$Chicago$&quot;</span>
Class=Ports
ClassGuid={4D36E978-E325-11CE-BFC1-08002BE10318}
Provider=%ATMEL%
DriverVer=09/12/2006,1.1.1.5
[DestinationDirs]
DefaultDestDir=12
[Manufacturer]
%ATMEL%=AtmelMfg
[AtmelMfg]
%USBtoSerialConverter%=USBtoSer.Install,USB\VID_03EB&amp;PID_6127&amp;MI_00
%USBtoSerialConverter%=USBtoSer.Install,USB\VID_03EB&amp;PID_6128&amp;MI_00
%USBtoSerialConverter%=USBtoSer.Install,USB\VID_03EB&amp;PID_6129&amp;MI_00
%USBtoSerialConverter%=USBtoSer.Install,USB\VID_03EB&amp;PID_6119&amp;MI_00
%USBtoSerialConverter%=USBtoSer.Install,USB\VID_03EB&amp;PID_6119&amp;MI_02
[USBtoSer.Install]
include=mdmcpq.inf
CopyFiles=FakeModemCopyFileSection
AddReg=USBtoSer.AddReg
[USBtoSer.AddReg]
HKR,,DevLoader,,*ntkern
HKR,,NTMPDriver,,usbser.sys
HKR,,EnumPropPages32,,<span class="stringliteral">&quot;MsPorts.dll,SerialPortPropPageProvider&quot;</span>
[USBtoSer.Install.Services]
AddService=usbser,0x00000002,USBtoSer.AddService
[USBtoSer.AddService]
DisplayName=%USBSer%
ServiceType=1
StartType=3
ErrorControl=1
ServiceBinary=%12%\usbser.sys
[Strings]
ATMEL=<span class="stringliteral">&quot;ATMEL Corp.&quot;</span>
USBtoSerialConverter=<span class="stringliteral">&quot;AT91 USB to Serial Converter&quot;</span>
USBSer=<span class="stringliteral">&quot;USB Serial Driver&quot;</span>
</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>

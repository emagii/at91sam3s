<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SAM3S Software Package: USBD API Methods</title>
<link href="common/style.css" rel="stylesheet" type="text/css"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
    <div id="body">
        <div id="title">SAM3S Software Package 2.1</div>
        <div id="banner"></div>

<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="usb_library.html">USB Library</a>      </li>
      <li><a class="el" href="usbd_framework.html">AT91 USB device framework</a>      </li>
      <li><a class="el" href="usbd_api.html">USBD API</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>USBD API Methods </h1>  </div>
</div>
<div class="contents">
<h2><a class="anchor" id="api_fun"></a>
USBD API methods</h2>
<p>The USB API provides serveral methods to perform the following operations:</p>
<ul>
<li>Changing the device state<ul>
<li><a class="el" href="usbd_api_method.html#USBD_Init">USBD_Init</a></li>
<li><a class="el" href="usbd_api_method.html#usbd_conn_api">USBD_Connect, USBD_Disconnect</a></li>
<li><a class="el" href="usbd_api_method.html#USBD_SetAddress">USBD_SetAddress</a></li>
<li><a class="el" href="usbd_api_method.html#USBD_SetConfiguration">USBD_SetConfiguration</a></li>
<li><a class="el" href="usbd_api_method.html#USBD_GetState">USBD_GetState</a></li>
<li><a class="el" href="usbd_state_diagram.html">USB Device State Diagram</a></li>
</ul>
</li>
<li>Handling events coming from the USB controller<ul>
<li><a class="el" href="group__usbd__hal.html#ga571a674fe9f9a1bba6ad08b3b0b28a80">USBD_IrqHandler</a></li>
</ul>
</li>
<li>Modifying the behavior of an endpoint<ul>
<li><a class="el" href="usbd_api_method.html#USBD_ConfigureEndpoint">USBD_ConfigureEndpoint</a></li>
<li><a class="el" href="usbd_api_method.html#USBD_Stall">USBD_Stall</a></li>
<li><a class="el" href="usbd_api_method.html#usbd_halt_api">USBD_Halt, USBD_Unhalt, USBD_IsHalted</a></li>
</ul>
</li>
<li>Transferring data<ul>
<li><a class="el" href="usbd_api_method.html#USBD_Write">USBD_Write</a></li>
<li><a class="el" href="usbd_api_method.html#USBD_Read">USBD_Read</a></li>
<li>USBD_IsoWrite</li>
</ul>
</li>
<li>Special functions<ul>
<li><a class="el" href="group__usbd__interface.html#gacfd4fed846cba74af43e668e47b6dc10">USBD_RemoteWakeUp</a></li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="ctrl_state"></a>
Controlling the Device State</h2>
<p>Chapter 9 of the USB specification 2.0 describes the various states a device can be in. Most of the methods of this API are used to change between those states.</p>
<h3><a class="anchor" id="USBD_Init"></a>
USBD_Init</h3>
<p><a class="el" href="usbd_api_method.html#USBD_Init">USBD_Init</a> is the first method to call in a user application. Technically, it must occur just before entering the Attached state. It performs the following actions:</p>
<ul>
<li>USB Device driver and endpoint state initialization</li>
<li>D+ pull-up configuration and disabling</li>
<li>UDP hardware initialization (Peripheral and clock init)</li>
</ul>
<p>A USB device uses a pull-up on the D+ line to signal its connection to the host. Depending on the USB controller present on the chip, either an internal or external pull-up is used. In both cases, its configuration is performed directly by this method. Please refer to the documentation of a particular controller for more information about the D+ pull-up.</p>
<p>The ini callback has to perform several mandatory operations at this point. You can find the default operations in USBDCallbacks_Initialized.</p>
<h3><a class="anchor" id="usbd_conn_api"></a>
USBD_Connect, USBD_Disconnect</h3>
<p>These two methods control the state of the D+ upll-up. This makes it possible to connect of disconnect the device by software when needed. <a class="el" href="group__usbd__interface.html#ga71b9264662d74666e4b058984e3346e5">USBD_Connect</a> changes the device state from Powered to Default, while <a class="el" href="group__usbd__interface.html#ga2d952f8cf9bde552cfd5559ae47e70fc">USBD_Disconnect</a> changes from either Default, Address or Configured to Powered.</p>
<h3><a class="anchor" id="USBD_SetAddress"></a>
USBD_SetAddress</h3>
<p><a class="el" href="usbd_api_method.html#USBD_SetAddress">USBD_SetAddress</a> extracts the information from the last received SETUP packet to either change the device state from Default to Address or from Address to Default. The difference is made depending on the value of the wValue field of the request.</p>
<p>This method must only be called right after the SET_ADDRESS request is received.</p>
<h3><a class="anchor" id="USBD_SetConfiguration"></a>
USBD_SetConfiguration</h3>
<p>This function operates in a way similar to <a class="el" href="usbd_api_method.html#USBD_SetAddress">USBD_SetAddress</a>. When the SETUP packet containing a SET_CONFIGURATION request is received, <a class="el" href="usbd_api_method.html#USBD_SetConfiguration">USBD_SetConfiguration</a> should be called to extract the new configuration value to adopt. If the wValue field of the request is non-zero, then the device must adopt the new configuration and enter the Configuration state; otherwise, it returns (or stays) in the Address state.</p>
<h3><a class="anchor" id="USBD_GetState"></a>
USBD_GetState</h3>
<p>As its name implies, USBD_GetState simply returns the current state of the USB driver. See state definitions on <a class="el" href="group__usbd__states.html">USB device states</a>.</p>
<ul>
<li><a class="el" href="group__usbd__states.html#gae2b41659195da2defd648d00d4e51a40">USBD_STATE_SUSPENDED</a></li>
<li><a class="el" href="group__usbd__states.html#ga48a1fa4d6ff3e963b7aa0833c2701451">USBD_STATE_ATTACHED</a></li>
<li><a class="el" href="group__usbd__states.html#ga6087761193af9391a593cda525cf5052">USBD_STATE_POWERED</a></li>
<li><a class="el" href="group__usbd__states.html#ga423cf90a532bc936797b17a49ae6848e">USBD_STATE_DEFAULT</a></li>
<li><a class="el" href="group__usbd__states.html#gaf3f4f1e1235247cc20df596c17b1b026">USBD_STATE_ADDRESS</a></li>
<li><a class="el" href="group__usbd__states.html#ga4d1e58829e5878c4d2c23eac1f192358">USBD_STATE_CONFIGURED</a></li>
</ul>
<h3><a class="anchor" id="Device"></a>
State Diagram</h3>
<p>See <a class="el" href="usbd_state_diagram.html">USB Device State Diagram</a></p>
<h2><a class="anchor" id="event_hdl"></a>
Event Handling (\ref USBD_IrqHandler)</h2>
<p>Several events can occur at the USB controller level:</p>
<ul>
<li>End of bus reset</li>
<li>Reception of a SETUP packet</li>
<li>Change of bus activity (active -&gt; idle -&gt; active ..)</li>
<li>Completin of an endpoint operation</li>
<li>...</li>
</ul>
<p>Whenever such an event occurs, it must be forwarded to the USBD API to be handled in an appropriate way. The USBD_IrqHandler performs this functionality, so the controller interrupt must be configured to call it.</p>
<p>Several <b>callbacks</b> can be triggered depending on the event notified by the controller:</p>
<ul>
<li>Suspend, when the bus is idle</li>
<li>Resume, when the bus becomes active again</li>
<li>NewRequest, when a setup packet is received on a control endpoint</li>
<li>StartOfFrame, every 1 ms (for full-speed controllers) or 125us (for high- speed controllers)</li>
</ul>
<p>More information about these callbacks and their expected behavior can be found in <a class="el" href="usbd_callback_api.html">USBD Callback API</a>.</p>
<h2><a class="anchor" id="ep_fun"></a>
Endpoint Behavior Modification</h2>
<p>The USBD API offers following functions to control how an endpoint operates.</p>
<ul>
<li><a class="el" href="usbd_api_method.html#USBD_ConfigureEndpoint">USBD_ConfigureEndpoint</a></li>
<li><a class="el" href="usbd_api_method.html#USBD_Stall">USBD_Stall</a></li>
<li><a class="el" href="group__usbd__interface.html#ga02adabcf042f350cc045fb2c798bb4e9">USBD_Halt</a></li>
<li><a class="el" href="group__usbd__interface.html#gae0ae896eb63155735b328c157fdc80a9">USBD_Unhalt</a></li>
<li><a class="el" href="group__usbd__interface.html#gaf469bcfbab3b7f7e211d550e79e0b3c8">USBD_IsHalted</a></li>
</ul>
<h3><a class="anchor" id="USBD_ConfigureEndpoint"></a>
USBD_ConfigureEndpoint</h3>
<p><a class="el" href="usbd_api_method.html#USBD_ConfigureEndpoint">USBD_ConfigureEndpoint</a> is used to configure an endpoint at the USB controller level. An appropriate endpoint descriptor must be provided to do that. The descriptor is used to configure the endpoint type (either Control, Bulk, Interrupt or Isochronous), direction (IN or OUT) and address.</p>
<p>Control endpoint 0 is automatically configured by the USBD API when the End of bus reset event is signalled by the USB controller. Therefore, there is no need to do it manually.</p>
<h3><a class="anchor" id="USBD_Stall"></a>
USBD_Stall</h3>
<p>The <a class="el" href="usbd_api_method.html#USBD_Stall">USBD_Stall</a> method causes and endpoint to acknowledge its next received packet with a STALL handshake. Further packets are then handled normally.</p>
<p>Most of the time, this method should be used with endpoint 0 to signal the host that the device cannot process a command.</p>
<h3><a class="anchor" id="usbd_halt_api"></a>
USBD_Halt, USBD_Unhalt, USBD_IsHalted</h3>
<p><a class="el" href="group__usbd__interface.html#ga02adabcf042f350cc045fb2c798bb4e9">USBD_Halt</a> sets the Halt status of an endpoint. When in Halt mode, every received packet is acknowledged with a STALL handshake instead of being handled normally.</p>
<p><em>USB_Halt</em> can be called either with the USB_SET_FEATURE, USB_CLEAR_FEATURE or USB_GET_STATUS parameter to modify the endpoint Halt state.</p>
<p><a class="el" href="group__usbd__interface.html#gae0ae896eb63155735b328c157fdc80a9">USBD_Unhalt</a> clears the Halt status of an endpoint.</p>
<p><a class="el" href="group__usbd__interface.html#gaf469bcfbab3b7f7e211d550e79e0b3c8">USBD_IsHalted</a> gets the Halt status of an endpoint.</p>
<h2><a class="anchor" id="data_tran"></a>
Data Transfer</h2>
<p>Data transfer (IN or OUT) on an endpoint can be performed by calling two methods, USBD_Write and USBD_Read.</p>
<h3><a class="anchor" id="USBD_Write"></a>
USBD_Write</h3>
<p>The USBD_Write function sends a data payload on a specific endpoint. If the data payload equals or exceeds the maximum packet size of the endpoint, then several IN transactions are necessary. This method should only be called on an IN or Control endpoint.</p>
<p>The write is performed <b>asynchronously</b>, i.e., the function returns immediately without waiting for the transfer to finish. When the transfer is complete, an optional user-provided callback function is called. This makes it possible to create an <b>OS-friendly synchronous function</b> by locking and unlocking a semaphore before and after each write.</p>
<p>This function handles double-buffering, if it is supported by the USB controller and if it has been enabled for the endpoint. Do not forget that using double-buffering is mandatory for isochronous transactions.</p>
<ul>
<li><b>Note</b> The double-buffering this function supported is only in period of each write action. That is, when the function is invoked to start transfer trunk of data, the data is automatically splitted to several IN transactions and ping-pong is started on the 2nd transaction. But when all the data of the trunk is finished the ping-pong is stopped. So it can not process the list of buffer that should use double-buffering all the time. See USBD_IsoWrite for such kind of operations.</li>
</ul>
<h3><a class="anchor" id="USBD_Read"></a>
USBD_Read</h3>
<p>The <a class="el" href="usbd_api_method.html#USBD_Read">USBD_Read</a> reads incoming data on an endpoint. The transfer stops either when the provided buffer is full, or a short packet (size inferior to the endpoint maximum packet size) is received. This method must only be called on an OUT or Control endpoint.</p>
<p>The read is performed <b>asynchronously</b>, i.e., the function returns immediately without waiting for the transfer to finish. When the transfer is complete, an optional user-provided callback function is called. This makes it possible to create an <b>OS-friendly synchronous function</b> by locking and unlocking a semaphore before and after each read.</p>
<p>This function handles <b>double-buffering</b>, if it is supported by the USB controller and if it has been enabled for the endpoint. Do not forget that using double-buffering is mandatory for isochronous transactions.</p>
<h3><a class="anchor" id="USBD_IsoWrite"></a>
USBD_IsoWrite</h3>
<p>The <a class="el" href="usbd_api_method.html#USBD_IsoWrite">USBD_IsoWrite</a> function sends a buffer list on a specific endpoint. The each buffer's payload should be equals or less than the maximum packet size of the endpoint. The transfer ends when all buffera are sent out. And the buffer is previously sent can be filled with new data before the transfer ends. To maitain a ring buffer for the outgoing stream. This method should only be called on an ISO IN endpoint.</p>
<p>The write is performed <b>asynchronously</b>, i.e., the function returns immediately without waiting for the transfer to finish. When the transfer is complete, an optional user-provided callback function is called. This makes it possible to create an <b>OS-friendly synchronous function</b> by locking and unlocking a semaphore before and after each write.</p>
<p>This function handles double-buffering, if it is supported by the USB controller and if it has been enabled for the endpoint. Do not forget that using double-buffering is mandatory for isochronous transactions.</p>
<h2><a class="anchor" id="special_fun"></a>
Special Functions</h2>
<ul>
<li><a class="el" href="group__usbd__interface.html#gacfd4fed846cba74af43e668e47b6dc10">USBD_RemoteWakeUp()</a> : This method starts a remote wakeup procedure. This makes it possible for a suspended device to wake a host with may itself be suspended. </li>
</ul>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>

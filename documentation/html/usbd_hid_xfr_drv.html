<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SAM3S Software Package: USB Device HID %Transfer Driver</title>
<link href="common/style.css" rel="stylesheet" type="text/css"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
    <div id="body">
        <div id="title">SAM3S Software Package 2.1</div>
        <div id="banner"></div>

<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="usb_library.html">USB Library</a>      </li>
      <li><a class="el" href="usbd_framework.html">AT91 USB device framework</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>USB Device HID Transfer Driver </h1>  </div>
</div>
<div class="contents">
<p>This page describes how to use the <a class="el" href="usbd_framework.html">AT91 USB device framework</a> to produce a USB HID Transfer driver, which appears as a USB HID complient device on host.</p>
<p>Details about the USB and the HID class can be found in the <em>USB specification 2.0</em> and the <em>HID specification 1.11</em>, respectively.</p>
<h2><a class="anchor" id="References"></a>
References</h2>
<ul>
<li><a class="el" href="usbd_framework.html">AT91 USB device framework</a></li>
<li><a class="el" href="usbd_enum.html">USB Device Enumeration</a></li>
<li><a href="http://www.usb.org/developers/docs/usb_20_040908.zip">Universal Serial Bus Revision 2.0 specification </a> (.zip file format, size 9.80 MB)</li>
<li><a href="http://www.usb.org/developers/devclass_docs/HID1_11.pdf">Device Class Definition for HID 1.11</a></li>
<li><a href="http://www.usb.org/developers/devclass_docs/Hut1_12.pdf">HID Usage Tables 1.12</a></li>
</ul>
<h2><a class="anchor" id="hid_basic"></a>
HID Basic</h2>
<p>See <a class="el" href="usb_hid_basic.html">USB HID Basic</a>.</p>
<h2><a class="anchor" id="Architecture"></a>
Architecture</h2>
<p>See <a class="el" href="usbd_framework_arch.html">USB Device Framework Architecture</a>.</p>
<h2><a class="anchor" id="Descriptors"></a>
Descriptors</h2>
<h3><a class="anchor" id="dev_desc"></a>
Device Descriptor</h3>
<p>The Device descriptor of an HID device is very basic, since the HID class code is only specified at the Interface level. Thus, it only contains standard values, as shown below: </p>
<div class="fragment"><pre class="fragment"><span class="keyword">static</span> <span class="keyword">const</span> USBDeviceDescriptor deviceDescriptor = {

    <span class="keyword">sizeof</span>(USBDeviceDescriptor),
    <a class="code" href="group__usb__desc__type.html#ga6363c61655b33b6312f0de0f317528e3">USBGenericDescriptor_DEVICE</a>,
    <a class="code" href="group__usb__release__number.html#ga69167f83b560d92391cf222d9d3690de">USBDeviceDescriptor_USB2_00</a>,
    <a class="code" href="group__usb__hid__device__descriptor__codes.html#ga2dc2dcdb10bdedecb99386913d75c127">HIDDeviceDescriptor_CLASS</a>,
    <a class="code" href="group__usb__hid__device__descriptor__codes.html#gae04ae0cf919376f90f71f718ba64fa5c">HIDDeviceDescriptor_SUBCLASS</a>,
    <a class="code" href="group__usb__hid__device__descriptor__codes.html#gae39adc3f4d0d0134f793dd15565d442c">HIDDeviceDescriptor_PROTOCOL</a>,
    BOARD_USB_ENDPOINTS_MAXPACKETSIZE(0),
    HIDDKeyboardDriverDescriptors_VENDORID,
    HIDDKeyboardDriverDescriptors_PRODUCTID,
    HIDDKeyboardDriverDescriptors_RELEASE,
    1, <span class="comment">// Index of manufacturer description</span>
    2, <span class="comment">// Index of product description</span>
    3, <span class="comment">// Index of serial number description</span>
    1  <span class="comment">// One possible configuration</span>
};
</pre></div><p> Note that the Vendor ID is a special value attributed by the USB-IF organization. The product ID can be chosen freely by the vendor.</p>
<h3><a class="anchor" id="Configuration"></a>
Descriptor</h3>
<p>Since one interface is required by the HID specification, this must be specified in the Configuration descriptor. There is no other value of interest to put here. </p>
<div class="fragment"><pre class="fragment"><span class="comment">// Configuration descriptor</span>
{
    <span class="keyword">sizeof</span>(USBConfigurationDescriptor),
    <a class="code" href="group__usb__desc__type.html#ga3a0e7ca09c79c9b17866b19770d7dfe7">USBGenericDescriptor_CONFIGURATION</a>,
    <span class="keyword">sizeof</span>(HIDDKeyboardDriverConfigurationDescriptors),
    1, <span class="comment">// One interface in this configuration</span>
    1, <span class="comment">// This is configuration #1</span>
    0, <span class="comment">// No associated string descriptor</span>
    BOARD_USB_BMATTRIBUTES,
    <a class="code" href="group__usb__attributes.html#gab63528cba8ea4c8178d79393caa5d5f1">USBConfigurationDescriptor_POWER</a>(100)
},
</pre></div><p> When the Configuration descriptor is requested by the host (by using the GET_DESCRIPTOR command), the device must also sent all the related descriptors, i.e. Interface, <a class="el" href="struct_endpoint.html">Endpoint</a> and Class-Specific descriptors. It is convenient to create a single structure to hold all this data, for sending everything in one chunk. In the example software, a HIDDKeyboardDriverConfigurationDescriptors structure has been declared for that.</p>
<h3><a class="anchor" id="hid_class_if_desc"></a>
HID Class Interface Descriptor</h3>
<p>Since a keyboard device needs to transmit as well as receive data, two Interrupt (IN &amp; OUT) endpoints are needed. This must be indicated in the Interface descriptor. Conversely to the mouse example, the Boot protocol is not implemented here, since there are more constraints on a keyboard device. </p>
<div class="fragment"><pre class="fragment"><span class="comment">// Interface descriptor</span>
{
    <span class="keyword">sizeof</span>(USBInterfaceDescriptor),
    <a class="code" href="group__usb__desc__type.html#ga82c82ea74c0f8b487812ad73cc5ed4a4">USBGenericDescriptor_INTERFACE</a>,
    0, <span class="comment">// This is interface #0</span>
    0, <span class="comment">// This is alternate setting #0</span>
    2, <span class="comment">// Two endpoints used</span>
    <a class="code" href="group__usb__hid__interface__descriptor__codes.html#gaf2104b73419b04d61be2ce67b537d72e">HIDInterfaceDescriptor_CLASS</a>,
    <a class="code" href="group__usb__hid__interface__descriptor__codes.html#ga4b7dba546d6bad75830e948523ad4e04">HIDInterfaceDescriptor_SUBCLASS_NONE</a>,
    <a class="code" href="group__usb__hid__interface__descriptor__codes.html#gaaf85fc6438251cb01581ef889beaac94">HIDInterfaceDescriptor_PROTOCOL_NONE</a>,
    0  <span class="comment">// No associated string descriptor</span>
},
</pre></div><h3><a class="anchor" id="hid_desc"></a>
HID Descriptor</h3>
<p>While a HID keyboard produces two different reports, one Input and one Output, only one Report descriptor can be used to describe them. Since having Physical descriptors is also useless for a keyboard, there will only be one HID class descriptor specified here.</p>
<p>For a keyboard, the <em>bCountryCode</em> field can be used to specify the language of the key caps. As this is optional, it is simply set to 00h in the example: </p>
<div class="fragment"><pre class="fragment"><span class="comment">// HID descriptor</span>
{
    <span class="keyword">sizeof</span>(HIDDescriptor),
    <a class="code" href="group__usb__descriptors__types.html#ga367ba1e1a811fbd2a592fecdf8c749b9">HIDGenericDescriptor_HID</a>,
    <a class="code" href="group__usb__hid__ver.html#gafa386251af83d31d881e7432a699e0d7">HIDDescriptor_HID1_11</a>,
    0, <span class="comment">// Device is not localized, no country code</span>
    1, <span class="comment">// One HID-specific descriptor (apart from this one)</span>
    <a class="code" href="group__usb__descriptors__types.html#ga3f66cac5f6a03f8059033a5c8b8f5aa3">HIDGenericDescriptor_REPORT</a>,
    HIDDKeyboardDriverDescriptors_REPORTSIZE
},
</pre></div><h3><a class="anchor" id="hid_rep_desc"></a>
Report Descriptor</h3>
<p>Two current reports are defined in the Report descriptor. The first one is used to notify the host of which keys are pressed, with both modifier keys (alt, ctrl, etc.) and alphanumeric keys. The second report is necessary for the host to send the LED (num lock, caps lock, etc.) states.</p>
<p>The Report descriptor starts with the global device functionality, described with a <b>Usage Page</b> and a <b>Usage</b> items: </p>
<div class="fragment"><pre class="fragment"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hiddReportDescriptor[] = {

    <a class="code" href="group__usb__hid__global.html#ga061eb06e882ca0f789bd5b1a3b1a5f26">HIDReport_GLOBAL_USAGEPAGE</a> + 2, 0xFF, 0xFF, <span class="comment">// Vendor-defined</span>
    <a class="code" href="group__usb__hid__local.html#gaea198289aa097a6fa63ee04c7680de7f">HIDReport_LOCAL_USAGE</a> + 1, 0xFF, <span class="comment">// Vendor-defined</span>
</pre></div><p>An Application collection is then defined to group the reports together: </p>
<div class="fragment"><pre class="fragment">    <a class="code" href="group__usb__hid__main.html#ga7278559a1803f6ed87799f236708c402">HIDReport_COLLECTION</a> + 1, HIDReport_COLLECTION_APPLICATION,
</pre></div><p>The first report to be defined is the input report, all data in the buffer is vendor defined: </p>
<div class="fragment"><pre class="fragment">        <span class="comment">// Input report: Vendor-defined</span>
        HIDReport_LOCAL_USAGE + 1, 0xFF, <span class="comment">// Vendor-defined usage</span>
        <a class="code" href="group__usb__hid__global.html#ga26bb26992198282e30b6fdb577431032">HIDReport_GLOBAL_REPORTCOUNT</a> + 1, HIDDTransferDriver_REPORTSIZE,
        <a class="code" href="group__usb__hid__global.html#ga6d06d4c43300f5a7f7a966337dd449ff">HIDReport_GLOBAL_REPORTSIZE</a> + 1, 8,
        <a class="code" href="group__usb__hid__global.html#ga09fec35b455b150e7c98a63e24658056">HIDReport_GLOBAL_LOGICALMINIMUM</a> + 1, (<span class="keywordtype">unsigned</span> char) -128,
        <a class="code" href="group__usb__hid__global.html#gaf11a15030c746900bbbe059a0911acb0">HIDReport_GLOBAL_LOGICALMAXIMUM</a> + 1, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)  127,
        <a class="code" href="group__usb__hid__main.html#gadb7a87519637326a285aa35cde2ed418">HIDReport_INPUT</a> + 1, 0,    <span class="comment">// No Modifiers</span>
</pre></div><p>The output report is then defined, data is for the user to decode: </p>
<div class="fragment"><pre class="fragment">        <span class="comment">// Output report: vendor-defined</span>
        HIDReport_LOCAL_USAGE + 1, 0xFF, <span class="comment">// Vendor-defined usage</span>
        HIDReport_GLOBAL_REPORTCOUNT + 1, HIDDTransferDriver_REPORTSIZE,
        HIDReport_GLOBAL_REPORTSIZE + 1, 8,
        HIDReport_GLOBAL_LOGICALMINIMUM + 1, (<span class="keywordtype">unsigned</span> char) -128,
        <a class="code" href="group__usb__hid__global.html#gaf11a15030c746900bbbe059a0911acb0">HIDReport_GLOBAL_LOGICALMAXIMUM</a> + 1, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)  127,
        <a class="code" href="group__usb__hid__main.html#ga824b49dd35f8d678b753d469bfe80f7f">HIDReport_OUTPUT</a> + 1, 0,    <span class="comment">// No Modifiers</span>
</pre></div><p>The last item, <em>End Collection</em>, is necessary to close the previously opened <em>Application Collection</em>. </p>
<div class="fragment"><pre class="fragment">    <a class="code" href="group__usb__hid__main.html#gabf8f95543e50538a0a917d9145dce548">HIDReport_ENDCOLLECTION</a>
};
</pre></div><p>The input report and output report are all user defined. We define the first byte as bit map of push buttons and LEDs, remaining bytes as data.</p>
<h3><a class="anchor" id="hid_phy_desc"></a>
Physical Descriptor</h3>
<p>A Physical descriptor is useless for a general transfer device, so none is defined in this example.</p>
<h3><a class="anchor" id="hid_ep_desc"></a>
Endpoint Descriptor</h3>
<p>Following the Interface and HID-specific descriptors, the two necessary endpoints are defined. </p>
<div class="fragment"><pre class="fragment"><span class="comment">// Interrupt IN endpoint descriptor</span>
{
    <span class="keyword">sizeof</span>(USBEndpointDescriptor),
    <a class="code" href="group__usb__desc__type.html#gad3370279f99871dff82504dcef7691d9">USBGenericDescriptor_ENDPOINT</a>,
    <a class="code" href="group__usb__ep__addr.html#ga97750e5e90d44f3732090a2ecc4f54f2">USBEndpointDescriptor_ADDRESS</a>(
        <a class="code" href="group__usb__ep__dir.html#ga833932f6a610e222c9f304b88253e27c">USBEndpointDescriptor_IN</a>,
        <a class="code" href="group__usbd__hid__keyboard__config.html#gab23b454d9a98f0896250e5361259498f">HIDDKeyboardDriverDescriptors_INTERRUPTIN</a>),
    USBEndpointDescriptor_INTERRUPT,
    <span class="keyword">sizeof</span>(HIDDKeyboardInputReport),
    <a class="code" href="group__usbd__hid__keyboard__config.html#ga4ce5996756821dfddae24fe0b7cfea55">HIDDKeyboardDriverDescriptors_INTERRUPTIN_POLLING</a>
},
<span class="comment">// Interrupt OUT endpoint descriptor</span>
{
    <span class="keyword">sizeof</span>(USBEndpointDescriptor),
    <a class="code" href="group__usb__desc__type.html#gad3370279f99871dff82504dcef7691d9">USBGenericDescriptor_ENDPOINT</a>,
    <a class="code" href="group__usb__ep__addr.html#ga97750e5e90d44f3732090a2ecc4f54f2">USBEndpointDescriptor_ADDRESS</a>(
        <a class="code" href="group__usb__ep__dir.html#gabc4606a47dbae4a95b77a0a4c8dd2533">USBEndpointDescriptor_OUT</a>,
        <a class="code" href="group__usbd__hid__keyboard__config.html#ga10e2679be9a3fa468a6a58d4c575f928">HIDDKeyboardDriverDescriptors_INTERRUPTOUT</a>),
    USBEndpointDescriptor_INTERRUPT,
    <span class="keyword">sizeof</span>(HIDDKeyboardOutputReport),
    <a class="code" href="group__usbd__hid__keyboard__config.html#ga4ce5996756821dfddae24fe0b7cfea55">HIDDKeyboardDriverDescriptors_INTERRUPTIN_POLLING</a>
}
</pre></div><h3><a class="anchor" id="hid_str_desc"></a>
String Descriptors</h3>
<p>Please refer to <a class="el" href="usbd_id_str.html">Usage: USBD VID, PID &amp; Strings</a>.</p>
<h2><a class="anchor" id="class_spec_req"></a>
Class-specific requests</h2>
<p>A driver request handler should first differentiate between class-specific and standard requests using the corresponding bits in the <em>bmRequestType</em> field. In most cases, standard requests can be immediately forwarded to the standard request handler method; class-specific methods must be decoded and treated by the custom handler.</p>
<h3><a class="anchor" id="GetDescriptor"></a>
GetDescriptor</h3>
<p>Three values have been added by the HID specification for the <b>GET_DESCRIPTOR</b> request. The high byte of the <em>wValue</em> field contains the type of the requested descriptor; in addition to the standard types, the <b>HID specification</b> adds the <b>HID descriptor</b> (21h), the <b>Report descriptor</b> (22h) and the <b>Physical descriptor</b> (23h) types.</p>
<p>There is no particular action to perform besides sending the descriptor. This can be done by using the <a class="el" href="group__usbd__interface.html#gafc4728f4af70056b3a271f333b759592">USBD_Write()</a> method, after the requested descriptor has been identified: </p>
<div class="fragment"><pre class="fragment"><span class="keywordflow">switch</span> (<a class="code" href="group__usb__request.html#gace388a4d862a1a39dfce506fe4189e82">USBGenericRequest_GetRequest</a>(request)) {

  <span class="keywordflow">case</span> <a class="code" href="group__usb__request__code.html#ga803e7404517dde3c061d08ea9d6bb12b">USBGenericRequest_GETDESCRIPTOR</a>:
    <span class="comment">// Check if this is a HID descriptor,</span>
    <span class="comment">// otherwise forward it to</span>
    <span class="comment">// the standard driver</span>
    <span class="keywordflow">if</span> (!HIDDKeyboardDriver_GetDescriptor(
        <a class="code" href="group__usb__request.html#ga56cc8072ee61b86e52620841df171c56">USBGetDescriptorRequest_GetDescriptorType</a>(request),
        <a class="code" href="group__usb__request.html#ga047e240a92a39eed9b3174d397498123">USBGenericRequest_GetLength</a>(request))) {

      <a class="code" href="group__usbd__interface.html#gaae0893893739fb365d088ea946cb2c89">USBDDriver_RequestHandler</a>(&amp;(hiddKeyboardDriver.usbdDriver),
                              request);
    }
    <span class="keywordflow">break</span>;

  <span class="keywordflow">default</span>:
    <a class="code" href="group__usbd__interface.html#gaae0893893739fb365d088ea946cb2c89">USBDDriver_RequestHandler</a>(&amp;(hiddKeyboardDriver.usbdDriver),
                                  request);
}
</pre></div><p> A slight complexity of the GET_DESCRIPTOR and SET_DESCRIPTOR requests is that those are standard requests, but the standard request handler (<a class="el" href="group__usbd__interface.html#gaae0893893739fb365d088ea946cb2c89">USBDDriver_RequestHandler()</a>) must not always be called to treat them (since they may refer to HID descriptors). The solution is to first identify GET/SET_DESCRIPTOR requests, treat the HID-specific cases and, finally, forward any other request to the standard handler.</p>
<p>In this case, a GET_DESCRIPTOR request for the Physical descriptor is first forwarded to the standard handler, and STALLed there because it is not recognized. This is done because the device does not have any Physical descriptors, and thus, does not need to handle the associated request.</p>
<h3><a class="anchor" id="SetDescriptor"></a>
SetDescriptor</h3>
<p>This request is optional and is never issued by most hosts. It is not implemented in this example.</p>
<h3><a class="anchor" id="GetReport"></a>
GetReport</h3>
<p>Since the HID keyboard defines two different reports, the Report Type value specified by this request (upper byte of the <em>wValue</em> field) must be examined to decide which report to send. If the type value is 01h, then the Input report must be returned; if it is 02h, the Output report is requested: </p>
<div class="fragment"><pre class="fragment"><span class="keywordflow">case</span> <a class="code" href="group__usb__hid__request__codes.html#ga944b2d3bc6adc1d7935367c0359fd2ad">HIDGenericRequest_GETREPORT</a>:
<span class="comment">//-------------------------------</span>
  type = <a class="code" href="group__usb__hid.html#ga7838b70a03055712db33a1d04f89f15f">HIDReportRequest_GetReportType</a>(request);
  length = <a class="code" href="group__usb__request.html#ga047e240a92a39eed9b3174d397498123">USBGenericRequest_GetLength</a>(request);
  <span class="keywordflow">switch</span> (type) {

      <span class="keywordflow">case</span> <a class="code" href="group__usb__hid__report__types.html#ga4ae15feb9a52459c355446d6441ec6f7">HIDReportRequest_INPUT</a>:

        <span class="comment">// Adjust size and send report</span>
        <span class="keywordflow">if</span> (length &gt; <span class="keyword">sizeof</span>(HIDDKeyboardInputReport)) {

          length = <span class="keyword">sizeof</span>(HIDDKeyboardInputReport);
        }
        <a class="code" href="group__usbd__interface.html#gafc4728f4af70056b3a271f333b759592">USBD_Write</a>(0, <span class="comment">// Endpoint #0</span>
           &amp;(hiddKeyboardDriver.inputReport),
           length,
           0, <span class="comment">// No callback</span>
           0);
        <span class="keywordflow">break</span>;

      <span class="keywordflow">case</span> <a class="code" href="group__usb__hid__report__types.html#gad03b4ea77c190004997643e6ce1e3b6e">HIDReportRequest_OUTPUT</a>:

        <span class="comment">// Adjust size and send report</span>
        <span class="keywordflow">if</span> (length &gt; <span class="keyword">sizeof</span>(HIDDKeyboardOutputReport)) {

          length = <span class="keyword">sizeof</span>(HIDDKeyboardOutputReport);
        }
        <a class="code" href="group__usbd__interface.html#gafc4728f4af70056b3a271f333b759592">USBD_Write</a>(0, <span class="comment">// Endpoint #0</span>
           &amp;(hiddKeyboardDriver.outputReport),
           length,
           0, <span class="comment">// No callback</span>
           0);
        <span class="keywordflow">break</span>;

      <span class="keywordflow">default</span>:
        <a class="code" href="group__usbd__interface.html#gad846cf5a2a002f83abe01d17d233f644">USBD_Stall</a>(0);
  }
<span class="keywordflow">break</span>;
</pre></div><h3><a class="anchor" id="SetReport"></a>
SetReport</h3>
<p>For an HID keyboard, the <b>SET_REPORT</b> command can be sent by the host to change the state of the LEDs. Normally, the dedicated Interrupt OUT endpoint will be used for this; but in some cases, using the default Control endpoint can save some bandwidth on the host side.</p>
<p>Note that the SET_REPORT request can be directed at the Input report of the keyboard; in this case, it can be safely discarded, according to the HID specification. Normally, most host drivers only target the Output report. The Report Type value is stored in the upper byte of the <em>wValue</em> field.</p>
<p>The length of the data phase to follow is stored in the <em>wLength</em> field of the request. It should be equal to the total length of the Output report. If it is different, the report status must still be updated with the received data as best as possible.</p>
<p>When the reception of the new data is completed, some processing must be done to enable/disable the corresponding LEDs. This is done in the callback function passed as an argument to <a class="el" href="group__usbd__interface.html#gaa786fa9bbfd3c2f64b5f486e537ffebb">USBD_Read()</a>: </p>
<div class="fragment"><pre class="fragment"><span class="keywordflow">case</span> <a class="code" href="group__usb__hid__request__codes.html#ga7aa68ba2665efff2f73549ea43b3b01e">HIDGenericRequest_SETREPORT</a>:
<span class="comment">//-------------------------------</span>
  type = <a class="code" href="group__usb__hid.html#ga7838b70a03055712db33a1d04f89f15f">HIDReportRequest_GetReportType</a>(request);
  length = <a class="code" href="group__usb__request.html#ga047e240a92a39eed9b3174d397498123">USBGenericRequest_GetLength</a>(request);
  <span class="keywordflow">switch</span>(type) {

    <span class="keywordflow">case</span> <a class="code" href="group__usb__hid__report__types.html#ga4ae15feb9a52459c355446d6441ec6f7">HIDReportRequest_INPUT</a>:
      <span class="comment">// SET_REPORT requests on input reports are ignored</span>
      <a class="code" href="group__usbd__interface.html#gad846cf5a2a002f83abe01d17d233f644">USBD_Stall</a>(0);
      <span class="keywordflow">break</span>;

    <span class="keywordflow">case</span> <a class="code" href="group__usb__hid__report__types.html#gad03b4ea77c190004997643e6ce1e3b6e">HIDReportRequest_OUTPUT</a>:
      <span class="comment">// Check report length</span>
      <span class="keywordflow">if</span> (length != <span class="keyword">sizeof</span>(HIDDKeyboardOutputReport)) {

        <a class="code" href="group__usbd__interface.html#gad846cf5a2a002f83abe01d17d233f644">USBD_Stall</a>(0);
      }
      <span class="keywordflow">else</span> {
      
        <a class="code" href="group__usbd__interface.html#gaa786fa9bbfd3c2f64b5f486e537ffebb">USBD_Read</a>(0, <span class="comment">// Endpoint #0</span>
          &amp;(hiddKeyboardDriver.outputReport),
          length,
          (<a class="code" href="group__usbd__interface.html#gabb63140a294168cea538f0bad09d561a">TransferCallback</a>) HIDDKeyboardDriver_ReportReceived,
          0); <span class="comment">// No argument to the callback function</span>
      }
      <span class="keywordflow">break</span>;

    <span class="keywordflow">default</span>:
      <a class="code" href="group__usbd__interface.html#gad846cf5a2a002f83abe01d17d233f644">USBD_Stall</a>(0);
  }
<span class="keywordflow">break</span>;
</pre></div><h3><a class="anchor" id="SetIdle"></a>
SetIdle</h3>
<p>In this case study, the <b>SET_IDLE</b> request is used to set a delay before a key is repeated. This is common behavior on keyboard devices. Usually, this delay is set to about 500 ms by the host.</p>
<p>The only action here is to store the new Idle rate. The management of this setting must be done in the main function, since Interrupt IN reports are sent from there.</p>
<p>In practice, it is not necessary to perform any action, apart from sending a zero-length packet to acknowledge it. The main application however has to make sure that only new reports are sent by the device. </p>
<div class="fragment"><pre class="fragment"><span class="keywordflow">case</span> <a class="code" href="group__usb__hid__request__codes.html#gaa9e8532b57cfd0c904a6dc954e958fd8">HIDGenericRequest_SETIDLE</a>:
<span class="comment">//-----------------------------</span>
  hiddKeyboardDriver.inputReportIdleRate =
           <a class="code" href="group__usb__hid.html#gadda4a9db20a64f37fefd3e3893171b4a">HIDIdleRequest_GetIdleRate</a>(request);
  <a class="code" href="group__usbd__interface.html#gafc4728f4af70056b3a271f333b759592">USBD_Write</a>(0, 0, 0, 0, 0);
<span class="keywordflow">break</span>;
</pre></div><h3><a class="anchor" id="GetIdle"></a>
GetIdle</h3>
<p>The only necessary operation for this request is to send the previously saved Idle rate. This is done by calling the USBD_Write method with the one-byte variable as its parameter: </p>
<div class="fragment"><pre class="fragment"><span class="keywordflow">case</span> <a class="code" href="group__usb__hid__request__codes.html#ga2749961ec8f4ecaa640a4dbd8097aa35">HIDGenericRequest_GETIDLE</a>:
<span class="comment">//-----------------------------</span>
  <a class="code" href="group__usbd__interface.html#gafc4728f4af70056b3a271f333b759592">USBD_Write</a>(0, &amp;(hiddKeyboardDriver.inputReportIdleRate), 1, 0, 0);
<span class="keywordflow">break</span>;
</pre></div><h3><a class="anchor" id="get_set_prot"></a>
GetProtocol, SetProtocol</h3>
<p>This HID keyboard example does not support the Boot protocol, so there is no need to implement the SET_PROTOCOL and GET_PROTOCOL requests. This means they can be safely STALLed when received.</p>
<h2><a class="anchor" id="main_app"></a>
Main Application</h2>
<p>Like the mouse example, the main program must perform two different operations. First, it has to monitor the physical inputs used as keys. In the example software, the buttons present on the evaluation boards are used to produce several modifier and alphanumeric keys.</p>
<p>Also, the main program is in charge of sending reports as they are modified, taking into account the Idle rate specified by the host. Idle rate management can be carried out by firing/resetting a timer once a new report is sent; if the timer expires, this means the Input report has not changed since. According to the HID specification, a single instance of the report must be sent in this case.</p>
<p>Finally, the HID specification also defines that if too many keys are pressed at the same time, the device should report an <em>ErrorRollOver</em> usage value (01h) in every byte of the key array. This has to be handled by the main application as well. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>

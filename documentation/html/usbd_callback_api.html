<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SAM3S Software Package: USBD Callback API</title>
<link href="common/style.css" rel="stylesheet" type="text/css"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
    <div id="body">
        <div id="title">SAM3S Software Package 2.1</div>
        <div id="banner"></div>

<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="usb_library.html">USB Library</a>      </li>
      <li><a class="el" href="usbd_framework.html">AT91 USB device framework</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>USBD Callback API </h1>  </div>
</div>
<div class="contents">
<h2><a class="anchor" id="cb_api"></a>
Callback API</h2>
<p>The callback API is a means of communication between the user application and the USBD API. When particular operations must be performed, the USB driver calls serveral external functions, refferred to as <b>callbacks</b>. They can also be invoked to notify the user application of pending events.</p>
<p>Defining all callbacks is not mandatory. For example, if the device shall not enter low-power mode, then it is appropriate not to provide a Suspend callback. If a callback is mandatory, this is notified in its description.</p>
<p>See USBDCallbacks.h for callback definitions.</p>
<h2><a class="anchor" id="Callback"></a>
Invocation</h2>
<p>The following events can trigger a callback:</p>
<ul>
<li>USB initialization: <a class="el" href="group__usbd__interface.html#ga5579e02a71a8f510005e873fc50a0f4a">USBDCallbacks_Initialized</a></li>
<li>End of bus reset: <a class="el" href="group__usbd__interface.html#ga9e41562d2721787dbca41dd5bd574fb3">USBDCallbacks_Reset</a></li>
<li>Device suspend: <a class="el" href="group__usbd__interface.html#gaf30332628067d1dd8cd1a177f5dc66ac">USBDCallbacks_Suspended</a></li>
<li>Device resume: <a class="el" href="group__usbd__interface.html#gac077464ce6090a99a999031ee2b43abc">USBDCallbacks_Resumed</a></li>
<li>SETUP request received: <a class="el" href="group__usbd__ccid.html#ga9c59dbbbbf5065ba8da4fbf81d9f65d9">USBDCallbacks_RequestReceived</a></li>
<li>Start of a new USB frame</li>
</ul>
<div align="center">
<img src="USBDCallbackInvocationFlowchart.png" alt="USBDCallbackInvocationFlowchart.png"/>
<p><strong>Callback Invocation Flowchart</strong></p></div>
 <h3><a class="anchor" id="Init"></a>
Init</h3>
<p>The <a class="el" href="group__usbd__interface.html#ga5579e02a71a8f510005e873fc50a0f4a">USBDCallbacks_Initialized</a> callback is invoked when the <a class="el" href="usbd_api_method.html#USBD_Init">USBD_Init</a> method is called. It has to perform several mandatory steps to make it possible to use the API:</p>
<ul>
<li>If an OS is used, perform any specific operation to install the driver</li>
<li>Configure USB controller interrupt</li>
<li>Configure Vbus monitoring PIO and interrupt ( but it's in app layer now ) The USB controller interrupt must be configured to <b>call the USBD_IrqHandler</b> API function when triggered. This is necessary to have events happening at the USB controller level handled appropriately by the API.</li>
</ul>
<p>If a PIO pin is connected to VBus, it is possible to monitor it by configuring the pin as an input and enabling the PIO interrupt. The interrupt service routine should simply check the Vbus status and then call the <a class="el" href="group__usbd__interface.html#ga71b9264662d74666e4b058984e3346e5">USBD_Connect</a> and <a class="el" href="group__usbd__interface.html#ga2d952f8cf9bde552cfd5559ae47e70fc">USBD_Disconnect</a> function to put device into right state.</p>
<p>Finally, if an OS is being used, then the driver should probably be installed prior to use. Interrupt configuration may also be done differently. Please refer to the documentation of the OS for more information.</p>
<p>This callback is <b>mandatory</b>.</p>
<h3><a class="anchor" id="Reset"></a>
Reset</h3>
<p>When an End of bus reset has been detected, the USBDCallbacks_Reset callback is triggered. The callback should perform <b>initialization</b> or <b>re- initialization</b> of the user-level application. For example, a class driver like MSD should re-initialize its internal state when a USB reset is performed.</p>
<h3><a class="anchor" id="Suspend"></a>
Suspend</h3>
<p>When the USB device enters the Suspended state, the USB API notifies this state change by invoking the <a class="el" href="group__usbd__interface.html#gaf30332628067d1dd8cd1a177f5dc66ac">USBDCallbacks_Suspended</a> callback. This can happen either when the bus is idle or when the device is disconnected from the USB.</p>
<p>If the device should enter low-power mode when suspended, then this callback must perform the required operations to do so, e.g., switching to a slow clock, disabling PLLs, etc.</p>
<ul>
<li><em>Note: The electrical specification of the USB 2.0 defines a maximum current consumption of 500uA for suspended device. This includes the current passing through pull-ups and upll-downs.</em></li>
</ul>
<h3><a class="anchor" id="Resume"></a>
Resume</h3>
<p>The <a class="el" href="group__usbd__interface.html#gac077464ce6090a99a999031ee2b43abc">USBDCallbacks_Resumed</a> callback is invoked when the USB device leaves the Suspended state and returns to its previous state (either Powered, Default, Address or Configured). This may happen when activity is detected on the USB, or when the device gets connected.</p>
<p>If the device was in low-power mode because of the Suspend callback, then this callback must perform the necessary poerations to return the device into a normal operation mode, e.g., switching to a fast clock.</p>
<h3><a class="anchor" id="NewRequest"></a>
NewRequest</h3>
<p>When a SETUP request is received on a control endpoint, the USBD API layer triggers the USBDCallbacks_RequestReceived callback to notify the user application. The received request can then be accessed through the corresponding <a class="el" href="struct_u_s_b_generic_request.html">USBGenericRequest</a> structure.</p>
<p>SETUP packets are used for class-specific requests (e.g. <em>GetMaxLUN</em> in MSD) as well as standard USB requests (e.g. <em>SetConfiguration</em>). The former are described in <em>USB Device Class Documents</em>, such as the <em>Mass Storage Bulk Only 1.0</em>, the latter are defined in the USB Specification 2.0.</p>
<ul>
<li><em>Note: that SETUP requests which are not understood by the device should be acknowledged with a STALL handshake. This notifies the host that the device cannot process the command.</em></li>
</ul>
<p>This callback is <b>mandatory</b>.</p>
<h3><a class="anchor" id="StartOfFrame"></a>
StartOfFrame</h3>
<p>Every 1ms (for a full-speed device) or 125us (for a high-speed device) a new USB frame starts. A callback can be invoked whenever this occurs.</p>
<p>Because the start-of-frame interrupt puts some stress on the processor (since it is called a lot), it is only activated the corresponding callback is defined (<b>now it's NOT defined in current framework</b>). </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
